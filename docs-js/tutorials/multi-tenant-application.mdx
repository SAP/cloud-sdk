---
id: multi-tenant-application
title: Introduction to multi-tenant concepts
sidebar_label: Multi-Tenant Application
description: Introduction in the development of multi-tenant application using the SAP Cloud SDK.
keywords:
  - sap
  - cloud
  - sdk
  - cloud native
  - cloud sdk
  - sap cloud sdk
  - tutorial
  - multi tenancy application
  - SAAS
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

## Overview

The code discussed in this guide can be found on the [samples repository](https://github.com/SAP-samples/cloud-sdk-js/tree/main/samples/multi-tenant-application).
The idea of this tutorial is to explain the main concepts of a multi-tenant applications and how you implement them on SAP BTP.
The code samples are not a copy-paste solution for productive use, but a didactic sample.
You need to adjust things like application names or routes for your use case.

The term `multi-tenant application` is used by SAP for applications which are used by different organizations.
These organizations are potentially different companies or strongly separated parts of one company.
In any case each organization has its own subaccount on SAP BTP and subscribes to your multi-tenant application.
The term multi-tenant application is more or less a synonym for a software as a service (SAAS) offering.
The idea behind this architecture is, that the consumers share the application resources so that they are more effectively used.

Before we can introduce the first building blocks of such a multi-tenant application it is necessary to introduce some vocabulary:

- The SAP BTP account in which the application is deployed is called the `provider account`.
  This account is under the control of the application developer.
- The accounts using the application are called `subscriber accounts`.
  These accounts are controlled by the consumer.
- Note that the subscriber and provider account need to be in the same global account.
  In case you want to offer a service across global accounts you may follow the [service broker approach](https://blogs.sap.com/2022/03/11/consumability-across-global-btp-accounts-via-custom-service-brokers/) which has other limitations.
- A `tenant-aware service` separates the data of different `subscriber accounts` rigorously.
  If you build a multi-tenant application all services handling account specific data need to be tenant-aware services.

This guide focuses on points where we saw the need of a more detailed guide with samples.
The selection is related to support issues we had in the past and therefore this is not a complete guide.
Please also have a look at the following guides and tutorials offering detailed information:

- The [SAP-Hana-Academy](https://github.com/saphanaacademy/generator-saphanaacademy-saas) contains a complete SAAS example for CF and K8s.
- The [multi-tenant application documentation](https://help.sap.com/docs/BTP/65de2977205c403bbc107264b8eccf4b/5e8a2b74e4f2442b8257c850ed912f48.html) contains all technical details for development.
- The [approuter documentation](https://help.sap.com/docs/BTP/65de2977205c403bbc107264b8eccf4b/01c5f9ba7d6847aaaf069d153b981b51.html) explains the approuter concepts.
- There are many blogs talking about multi-tenant application development: [Sandeep provided a good overview](https://blogs.sap.com/2018/10/25/using-saas-registry-to-develop-multitenant-application-on-sap-cloud-platform-cloud-foundry-environment/) or [the blog from Raja is also a good starting point](https://blogs.sap.com/2022/08/27/fundamentals-of-multitenancy-in-sap-btp/).

## Prerequisites

To execute this tutorial you need:

- Two CF subaccounts in the same global account to represent provider and subscriber account.
- The provider accounts needs some quota:
  - To host two applications (sample application and approuter)
  - To create a service instance for the destination and XSUAA service
- You need a basic understanding of SAP BTP and the command line tools to deploy applications.

## The Application

We will focus on a simple application with a single endpoint.
This endpoint will call the destination service using the SAP Cloud SDK.
Since the destination service is tenant aware it can be used to illustrate service usage within your multi-tenant application.
You find the application code in the `multi-tenant-app` folder of the [sample repository](https://github.com/SAP-samples/cloud-sdk-js/tree/main/samples/multi-tenant-application).
The relevant application logic and configuration is located in the following three files:

- In the `applicaiton.ts` the different endpoints are defined.
  For now, we are only interested in the `/service` endpoint which represents our multi-tenant service.
- In the `manifest.yml` the route to the application is given and the used services are defined.
- In the `service-endpoint.ts` a small implementation is provided.
  A destination with the name `myDestination` is requested.
  We will discuss the details later on, once the application is deployed.

<Tabs groupId="code-files" defaultValue="application.ts" values={[{ label: 'application.ts', value: 'application.ts'},{ label: 'manifest.yml', value: 'manifest.yml'},{ label: 'service-endpoint.ts', value: 'service-endpoint.ts'}]}>
<TabItem value="application.ts" className="code-block-height-js thin-scrollbar">

```ts
import * as bodyParser from 'body-parser';
import express from 'express';
import { serviceRoute } from './service-endpoint';
import { dependencyRoute } from './dependencies-endpoint';
import { subscribeRoute, unsubscribeRoute } from './subscription-endpoint';

class App {
  public app: express.Application;

  constructor() {
    this.app = express();
    this.config();
    this.routes();
  }

  private config(): void {
    this.app.use(bodyParser.json());
    this.app.use(bodyParser.urlencoded({ extended: false }));
  }

  private routes(): void {
    const router = express.Router();

    router.get('/service', serviceRoute);
    router.get('/dependencies', dependencyRoute);
    router.put('/subscription/:subscriberTenantId', subscribeRoute);
    router.delete('/subscription/:subscriberTenantId', unsubscribeRoute);
    router.get('/index.html', (req, res) => {
      res.sendFile(join(__dirname, 'index.html'));
    });
    this.app.use('/', router);
  }
}

export default new App().app;
```

</TabItem>

<TabItem value="manifest.yml" className="code-block-height-js thin-scrollbar">

```yml
applications:
    - name: multi-tenant-sample-app
    path: .
    memory: 256M
    buildpacks:
        - nodejs_buildpack
    services:
        - destination
        - xsuaa
    routes:
        - route: 'multi-tenant-app.cfapps.eu10.hana.ondemand.com'
```

</TabItem>

<TabItem value="service-endpoint.ts" className="code-block-height-js thin-scrollbar">

```ts
import { Request, Response } from 'express';
import {
  decodeJwt,
  getDestination,
  retrieveJwt,
  subscriberFirst
} from '@sap-cloud-sdk/connectivity';
import { createLogger } from '@sap-cloud-sdk/util';

const logger = createLogger('destination');

export async function serviceRoute(req: Request, res: Response) {
  try {
    const jwt = retrieveJwt(req);
    const tenantId = jwt
      ? decodeJwt(jwt).zid
      : `No jwt given - provider tenant`;
    const destination = await getDestination({
      destinationName: 'myDestination',
      selectionStrategy: subscriberFirst,
      jwt
    });
    if (destination) {
      res.status(200).send(
        `You are on tenant: ${tenantId}.
           The destination description is: ${destination.originalProperties.Description}`
      );
    } else {
      res.status(404).send(`Destination with name 'myDestination' not found.`);
    }
  } catch (e) {
    logger.error(e);
    res.status(500).send('Error in retrieving destination - look at the logs.');
  }
}
```

</TabItem>
</Tabs>

### Deploy the Application

Before you can deploy the application you need to create a service instance for the destination and XSUAA service in your account.
You find a `xs-sercurity.json` in the `service-config` folder to create the XSUAA instance.
Align the name of your service instances with the ones in the `manifest.yml`.
Also adjust the route to use the region of your CF e.g. `cfapps.us10.hana.ondemand.com` and also adjust the route path to make it unique in the region.

Now you log into CF using the CLI `cf login` and enter the account information of the provider account.
Navigate to the `multi-tenant-app` folder and execute `cf push` to deploy the application.

### Call the Service

In our example the service is reachable via (for you the URL will be different depending on landscape):

```
GET https://multi-tenant-app.cfapps.eu10.hana.ondemand.com/service
```

If we have a look at the implementation of `service-endpoint.ts` above the service will try to obtain a JSON web token (JWT) from the request.
Then it will fetch a destination called `myDestination` using the destination service.
Since there is no destination with that name, the service will return `404`.

Create a destination with the name in your provider account and also enter some description for that destination.
After the destination is created the service should return:

```
You are on tenant: No jwt given - provider tenant. The destination description is: Provider Destination Description
```

## The Approuter

We have seen that there is no JWT attached to the request.
This task is done by the application router, the XSUAA and the identity provider (IdP).
The details would be too much for this guide.
Just think of the approuter as an application taking requests and initiating the authorization flow with the XSUAA and IdP.
Once the user entered the credentials, the request is sent to the target with the JWT issued for the user and account.
In a productive case the approuter may redirect requests to multiple applications.
In our simple example there is just one route.

The approuter does not require code, only configuration.
You find all files in `approuter` folder of the [samples repository](https://github.com/SAP-samples/cloud-sdk-js/tree/main/samples/multi-tenant-application):

- The `manifest.yml` contains the config for the approuter application
- The `xs-app.json` the config for the route resolution.

<Tabs groupId="code-files" defaultValue="manifest.yml" values={[{ label: 'manifest.yml', value: 'manifest.yml'},{ label: 'xs-app.json', value: 'xs-app.json'}]}>
<TabItem value="manifest.yml" className="code-block-height-js thin-scrollbar">

</TabItem>

<TabItem value="xs-app.json" className="code-block-height-js thin-scrollbar">

</TabItem>
</Tabs>

### Deploy the Approuter

Please adjust the route property in the `manifest.yml`.
Replace `s4sdk` with the subdomain of your provider account and adjust the landscape as well.
Log into the provider account using `cf login` and then you call `cf push` from the `approuter` directory.
This deploys the approuter.
Once the application is deployed you will see a second application running next to your `multi-tenant-app`.

When you open the application you see one route created by the manifest:

```
GET https://route-prefix-s4sdk.cfapps.eu10.hana.ondemand.com/
```

When you follow this route you will get redirected to the `welcomeFile` defined in the `xs-app.json`.
The `index.html` is located in the application.
How did the routing work:

- In our simple scenario the `xs-app.json` defines only one route consisting of a `source`, `target` and `destination`.
  The `source` is a regex and the target defines which capturing group is used in the destination.
  In our example `https://route-prefix-s4sdk.cfapps.eu10.hana.ondemand.com/anything` will lead to `anything` as the capturing group and `anything` is attached to the destination.
  There are many more options to the routing config explained [here](https://help.sap.com/docs/BTP/65de2977205c403bbc107264b8eccf4b/c103fb414988447ead2023f768096dcc.html).
- The `manifest.yml` defines the available destinations for the approuter.
  Here we see that the destination `multi-tenant-app` points to the URL of our application.
  Therefore `https://route-prefix-s4sdk.cfapps.eu10.hana.ondemand.com/anything` goes to `https://multi-tenant-app.cfapps.eu10.hana.ondemand.com/anything`

### Call the Service via the Approuter

The reason for introducing the approuter was the missing JWT in the request.
If you call the service via the approuter:

```
GET https://route-prefix-s4sdk.cfapps.eu10.hana.ondemand.com/service
```

you will see a response like:

```
You are on tenant: a89ea924-d9c2-4gaf-84fb-3ffcff123456. The destination description is: Provider Destination Description
```

which shows that the request contains a JWT issued for the provider account.

## The Subscription

Up to now, we consumed the application via the provider account.
We want to create the possibility to use the service from a different account.

The first thing to do is to create an instance of the `SAAS provisioning service` in your provider account.
You find the `saas-registry-config.json` in the [samples repository](https://github.com/SAP-samples/cloud-sdk-js/tree/main/samples/multi-tenant-application).
This makes the service subscribable form other accounts.
You need to adjust the `providerTenantId` to contain your ID and the `appUrls` to match your region and application URL.
Within the `saas-registry-config.json` two URLs are mentioned: the `getDependencies` and `onSubscription`.

<Tabs groupId="code-files" defaultValue="saas-registry-config.json" values={[{ label: 'saas-registry-config.json', value: 'saas-registry-config.json'},{ label: 'dependencies-endpoint.ts', value: 'dependencies-endpoint.ts'},{ label: 'subscription-endpoint.ts', value: 'subscription-endpoint.ts'}]}>
<TabItem value="saas-registry-config.json" className="code-block-height-js thin-scrollbar">

```json
{
  "xsappname": "xs-multi-tenant-sample-app",
  "appName": "multi-tenant-app",
  "providerTenantId": "a89ea924-d9c2-4eab-84fb-3ffca123456",
  "displayName": "multi tenant example application",
  "appUrls": {
    "getDependencies": "https://multi-tenant-app.cfapps.eu10.hana.ondemand.com/dependencies",
    "onSubscription": "https://multi-tenant-app.cfapps..eu10.hana.ondemand.com/subscription/{tenantId}"
  }
}
```

</TabItem>

<TabItem value="dependencies-endpoint.ts" className="code-block-height-js thin-scrollbar">

```ts
import { Request, Response } from 'express';
import * as xsenv from '@sap/xsenv';

const relevantServices = ['destination'];

export function dependencyRoute(req: Request, res: Response): void {
  res.status(200).send(
    relevantServices
      .map(s => {
        const services = xsenv.filterCFServices({ label: s });

        return services && services.length
          ? {
              appId:
                services[0].credentials.xsappname ||
                services[0].credentials.uaa.xsappname,
              appName: s
            }
          : null;
      })
      .filter(elem => elem)
  );
}
```

</TabItem>

<TabItem value="subscription-endpoint.ts" className="code-block-height-js thin-scrollbar">

```ts
import { Request, Response } from 'express';
import { createLogger } from '@sap-cloud-sdk/util';
import { executeHttpRequest } from '@sap-cloud-sdk/http-client';
import {
  bindRoute,
  createRoute,
  deleteRoute,
  getLandscape,
  getCfGuids
} from './subscription-util';

const logger = createLogger('subscription');
const appRouterName = 'approuter';

export async function subscribeRoute(req: Request, res: Response) {
  try {
    const subscribedSubdomain = req.body.subscribedSubdomain;
    const subscriberRoute = `https://route-prefix-${subscribedSubdomain}.${getLandscape()`;
    logger.info(`subscribe: ${subscriberRoute}`);

    const guids = await getCfGuids(appRouterName);
    const routeGuid = await createRoute(subscribedSubdomain, guids);
    await bindRoute(routeGuid, guids);

    res.status(200).send(subscriberRoute);
  } catch (e) {
    res.status(500).send(e.message);
  }
}

export async function unsubscribeRoute(req: Request, res: Response) {
  const subscribedSubdomain = req.body.subscribedSubdomain;
  logger.info(`un-subscribe: ${subscribedSubdomain}`);
  await deleteRoute(subscribedSubdomain);
  res.status(200).send('Unsubscribed.');
}
```

</TabItem>
</Tabs>

These two endpoints are the entry point for the SAP BTP platform to:

- Create and delete a subscription to the application
- Obtain the services used by the application

In our example the application uses the destination service.
The application has a binding to a service instance, so it is clear that the application may call the service.
However, the subscribed account does not know anything about the internal details of our application.
Therefore, the dependencies-endpoint provides the information that the destination service may be used also from the subscribed account.

Remember to add all SAP BTP services used by your application in this list.
If you do not do that you retrieve a 403 error from the XSUAA when you request a service token on behalf of a subscriber account.

### Creating a Subscription

After we created the instance of the `SAAS provisioning service` in the provider account, we can create a subscription via the user interface.
A subscription is only a route to the provider application including the unique subdomain of subscriber account.
The `TENANT_HOST_PATTERN` in the `manifest.yml` of the approuter defines how to extract the subscriber account from the URL.
A route like:

```
GET https://route-prefix-someSubscriberDomain.cfapps.eu10.hana.ondemand.com/service
```

would mean that the subscriber account is `someSubscriberDomain`.
Of course, you want to automate onboarding of new accounts as much as possible.
Hence, the `POST` method in the `subscription-endpoint.ts` create a route automatically:

- It creates a route
- Binds the created route to the approuter.
- Returns the route URL so that it can appear in the subscriber account.

The creation of the route uses the [CF API](https://v3-apidocs.cloudfoundry.org/version/3.126.0/index.html).
Unfortunately, there is no out-of-the-box access of this API when you are in the context of an application.
We assume a destination with the name `cf-api` in the sample implementation which contains the access data for the CF API:

| property          | value                                                 |
| ----------------- | ----------------------------------------------------- |
| name              | `cf-api`                                              |
| authentication    | `OAuth2Password`                                      |
| user              | a user with permission to the provider account        |
| password          | password of this user                                 |
| client id         | `cf`                                                  |
| client secret     | empty string                                          |
| token service URL | `https://login.cf.eu10.hana.ondemand.com/oauth/token` |
| URL               | `https://api.cf.eu10.hana.ondemand.com`               |

You have to adjust the URL and token service URL to for your region e.g. `https://api.cf.us10.hana.ondemand.com`.
Once the destination is present you can subscribe the application and routes are created automatically.

Log into your second SAP BTP account and create a subscription to the `multi-tenant-app` in the cockpit under `Service->Instances and Subscriptions`.
Once the application is subscribed, you can have a look at the approuter in the provider account.
You should see a second route with the subdomain of the subscriber.
If you call the new route:

```
GET https://route-prefix-someSubscriberDomain.cfapps.eu10.hana.ondemand.com/service
```

you will see a response with the tenant ID from the subscriber account:

```
You are on tenant: a89ea924-d9c2-4gaf-84fb-3ffcff7891011. The destination description is: Provider Destination Description.
```

The approuter has extracted the subscriber subdomain from the URL and issued a token for this account.
As an application developer you can use the token to determine the account which currently calls your code.

### Removing a Subscription

If the consumer deletes the subscription, the SAP BTP will invoke the `DELETE` method on the subscription-endpoint.
The code will remove the route from the application router and make the application not reachable anymore for that user.
The details of the implementation can be found in the `subscription-endpoint.ts` of the sample application.

## Real World View

The presented example is totally artificial.
We would like to explain a bit more how an actual multi-tenant application would look like and how the SAP Cloud SDK helps you.
Different consumer are divided by their unique application URL including their subdomain.
However, up to know nothing subscriber specific is happening in the implementation.

To get an idea create a destination in the subscriber account with the same name `myDestination` with a different description e.g. `Subscriber Destination`.
A call to the same `/service` endpoint will lead now :

```
You are on tenant: a89ea924-d9c2-4gaf-84fb-3ffcff7891011. The destination description is: Subscriber Destination.
```

The destination of the subscriber account is used at runtime, because the call in the `service-endpoint.ts` uses the selection strategy `subscriberFirst`.
You can change this by using [different selection strategies](https://sap.github.io/cloud-sdk/api/2.9.0/variables/sap_cloud_sdk_connectivity.DestinationSelectionStrategies).
This enables consumers to maintain their custom destination used within a multi-tenant application.
The destination from the provider account could be seen as a fallback.

This is only one example of a tenant-aware service.
You could imagine a database with a tenantId column to store consumer specific configuration.
You extract the value from the JWT as shown in the minimal example:

```ts
const jwt = retrieveJwt(req);
const tenantId = jwt ? decodeJwt(jwt).zid : `No jwt given - Provider Tenant?`;
//do something for the specific tenantId
```

Note that this guide is only a brief overview on topics where we saw a lack of good documentation.
We have not considered many important points like:

- [Custom domains](https://help.sap.com/docs/BTP/65de2977205c403bbc107264b8eccf4b/2291aea5e22440f7a161bdeb9c16b664.html) for your multi-tenant offering
- [Role and authorization concepts](https://help.sap.com/docs/BTP/65de2977205c403bbc107264b8eccf4b/56a71531fc154717bf221f9e293ba215.html) for your services
