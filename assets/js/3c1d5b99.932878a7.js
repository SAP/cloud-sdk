"use strict";(self.webpackChunksap_cloud_sdk_documentation=self.webpackChunksap_cloud_sdk_documentation||[]).push([[6009],{21428:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>m,frontMatter:()=>a,metadata:()=>i,toc:()=>h});const i=JSON.parse('{"id":"features/middleware","title":"Middleware","description":"How the SAP Cloud SDK behaviour is adjusted using middlewares.","source":"@site/docs-js/features/middleware.mdx","sourceDirName":"features","slug":"/features/middleware","permalink":"/cloud-sdk/docs/js/features/middleware","draft":false,"unlisted":false,"editUrl":"https://github.com/SAP/cloud-sdk/edit/main/docs-js/features/middleware.mdx","tags":[],"version":"current","frontMatter":{"id":"middleware","title":"Middleware","sidebar_label":"Middleware","description":"How the SAP Cloud SDK behaviour is adjusted using middlewares.","keywords":["sap","cloud","sdk","JavaScript","TypeScript","resilience","middleware"]},"sidebar":"docsJsSidebar","previous":{"title":"Execute an OpenAPI Request","permalink":"/cloud-sdk/docs/js/features/openapi/execute-request"},"next":{"title":"Error Handling","permalink":"/cloud-sdk/docs/js/features/error-handling"}}');var s=t(74848),o=t(28453),r=t(21122),d=t(86025);const a={id:"middleware",title:"Middleware",sidebar_label:"Middleware",description:"How the SAP Cloud SDK behaviour is adjusted using middlewares.",keywords:["sap","cloud","sdk","JavaScript","TypeScript","resilience","middleware"]},l=void 0,c={},h=[{value:"Concept",id:"concept",level:2},{value:"Implementation of a Middleware",id:"implementation-of-a-middleware",level:2},{value:"Order of Multiple Middlewares",id:"order-of-multiple-middlewares",level:2},{value:"Use the Middleware Context",id:"use-the-middleware-context",level:2},{value:"Change Request Parameters",id:"change-request-parameters",level:2},{value:"Execution Order of Middlewares",id:"execution-order-of-middlewares",level:2},{value:"Benefits of Middlewares",id:"benefits-of-middlewares",level:2}];function u(e){const n={a:"a",code:"code",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"concept",children:"Concept"}),"\n",(0,s.jsxs)(n.p,{children:["The main purpose of the SAP Cloud SDK is to execute asynchronous HTTP requests.\nThis can either happen via a generated ",(0,s.jsx)(n.a,{href:"./odata/execute-request#setting-middlewares",children:"OData"})," or ",(0,s.jsx)(n.a,{href:"./openapi/execute-request#setting-middlewares",children:"OpenAPI"})," client or the ",(0,s.jsx)(n.a,{href:"./connectivity/http-client#setting-middlewares",children:"http client"}),".\nThe examples presented in this guide use the http client, but all information applies to the typed clients as well.\nEither way, the final result after fetching destinations and doing various other things is an ",(0,s.jsx)(n.a,{href:"https://github.com/axios/axios",children:"axios"})," request.\nSometimes you want to adjust the way the SAP Cloud SDK executes the axios request."]}),"\n",(0,s.jsx)(n.p,{children:"With middlewares you can add custom functionality to the request execution.\nYou can add multiple middlewares to adjust requests to your needs."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"executeHttpRequest(\n  { url: 'http://example.com' },\n  {\n    middleware: [middlewareA, middlewareB, ...],\n    method: 'get'\n  }\n);\n"})}),"\n",(0,s.jsx)(n.p,{children:"The API for a middleware is as follows:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"/**\n * Type defining the function passed from one middleware to the next one.\n */\nexport type MiddlewareFunction = (\n  request: HttpRequest\n) => Promise<HttpResponse>;\n\n/**\n * The actual middleware type returning a function.\n */\nexport type Middleware = (options: MiddlewareOptions) => MiddlewareFunction;\n\n/**\n * The input options of the middleware.\n */\nexport interface MiddlewareOptions {\n  fn: MiddlewareFunction;\n  context: HttpMiddlewareContext;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Every middleware takes the ",(0,s.jsx)(n.code,{children:"MiddlewareOptions"})," as input and returns a ",(0,s.jsx)(n.code,{children:"MiddlewareFunction"})," instance.\nThe ",(0,s.jsx)(n.code,{children:"MiddlewareOptions"})," have the following properties:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:"fn()"})," function is the returned function from the previous middleware.\nFor the last one it is the original HTTP request from the SAP Cloud SDK.\nNote that the type of the input and return function are the same."]}),"\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:"context"})," provides information on the request like URL, headers and HTTP method."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Note that a middleware should ",(0,s.jsx)(n.strong,{children:"not"})," execute the function but construct and return a ",(0,s.jsx)(n.code,{children:"MiddlewareFunction"}),".\nYou can think of middlewares as a composition of functions where each middleware composes a new function.\nThis makes a chain of middlewares different from a pipeline where the functions are executed one after another.\nThis may seem abstract now, but the examples in the next sections will bring some concreteness to the topic."]}),"\n",(0,s.jsx)(n.h2,{id:"implementation-of-a-middleware",children:"Implementation of a Middleware"}),"\n",(0,s.jsx)(n.p,{children:"In this section you learn how to implement a middleware based on a didactic example.\nThe following middleware logs a text and leaves the original function unchanged."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const doSomethingBeforeMiddleware = options => {\n  return requestConfig => {\n    console.log('Implement something here.');\n    options.fn(requestConfig);\n  };\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In the example the custom code executes before the function ",(0,s.jsx)(n.code,{children:"fn()"}),".\nDo this when you want to adjust things before the actual HTTP request is executed.\nIf you want to process the result of the function in your middleware, implement it the following way:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const doSomethingAfterMiddleware = options => {\n  return requestConfig => {\n    options.fn(requestConfig).then(response => {\n      console.log('Do some postprocessing.');\n      return response;\n    });\n  };\n};\n"})}),"\n",(0,s.jsx)(n.p,{children:"Remember that the code you put outside the returned function is executed when the functions are composed.\nThis is in general not what you want."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const unintendedMiddleware = options => {\n  console.log(\n    'Executed when middleware is added - not what you want in general'\n  );\n  return options.fn;\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The example above is not really useful, but also not harmful.\nRemember that a middleware must ",(0,s.jsx)(n.strong,{children:"not"})," execute the original function.\nIt adds functionality to the function and creates a new function from it.\nIf you execute it, the whole middleware composition idea is destroyed."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const wrongMiddleware = options => {\n  //This would execute the function while the middlewares are added - Do NOT do this.\n  const responseRunning = options.fn(someArgs);\n  return requestConfig => responseRunning;\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"order-of-multiple-middlewares",children:"Order of Multiple Middlewares"}),"\n",(0,s.jsx)(n.p,{children:"A good practice is to define reusable, single-purpose middlewares.\nYou can add multiple of those middlewares to combine the effects.\nAssume you want to modify your call to have a timeout and use a fallback.\nThe implementation of these middlewares could look like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const timeoutMiddleware = options => {\n  return requestConfig =>\n    Promise.race([options.fn(requestConfig), timeoutPromise]);\n};\n\nconst fallbackMiddleware = options => {\n  return requestConfig => {\n    try {\n      return options.fn(requestConfig);\n    } catch (e) {\n      //implement some fallback logic\n    }\n  };\n};\n"})}),"\n",(0,s.jsx)(n.p,{children:"Multiple middlewares are added one-by-one to the request.\nThe elements are combined as if the composition operator \u2218 for functions is used."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"[middlewareA, middlewareB, ...] -> middlewareA after middlewareB after ...\n"})}),"\n",(0,s.jsx)(n.p,{children:"If you include the fallback and timeout middleware to your request in the following way:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"executeHttpRequest(\n  { url: 'http://example.com' },\n  {\n    middleware: [fallbackMiddleware, timeoutMiddleware],\n    method: 'get'\n  }\n);\n"})}),"\n",(0,s.jsxs)(n.p,{children:["it would mean ",(0,s.jsx)(n.code,{children:"fallbackMiddleware"})," after ",(0,s.jsx)(n.code,{children:"timeoutMiddleware"})," or a bit more detailed:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The initial function is a ",(0,s.jsx)(n.code,{children:"GET"})," request to ",(0,s.jsx)(n.code,{children:"http://example.com"})," called ",(0,s.jsxs)(n.em,{children:["f",(0,s.jsx)("sub",{children:"0"})]}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["The timeout is added first to the HTTP request leading ",(0,s.jsxs)(n.em,{children:["h",(0,s.jsx)("sub",{children:"1"})]})," in the picture below.\nTherefore, at execution the timeout only counts the execution time of ",(0,s.jsxs)(n.em,{children:["f",(0,s.jsx)("sub",{children:"0"})]})," and not considering a fallback call."]}),"\n",(0,s.jsxs)(n.li,{children:["After this the fallback is added around ",(0,s.jsxs)(n.em,{children:["h",(0,s.jsx)("sub",{children:"1"})]})," which is the function with timeout.\nSo the fallback would also handle failures due to the timeout."]}),"\n"]}),"\n",(0,s.jsx)(r.A,{alt:"Middleware execution order",sources:{light:(0,d.Ay)("img/middleware_light.svg"),dark:(0,d.Ay)("img/middleware_dark.svg")},className:"center",width:"100%"}),"\n",(0,s.jsx)(n.p,{children:"If you switched the order of the middlewares:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"executeHttpRequest(\n  { url: 'http://example.com' },\n  {\n    middleware: [timeoutMiddleware, fallbackMiddleware],\n    method: 'get'\n  }\n);\n"})}),"\n",(0,s.jsxs)(n.p,{children:["the timeout would apply to the original request plus additional time for potential fallback calls (see ",(0,s.jsxs)(n.em,{children:["g",(0,s.jsx)("sub",{children:"1"})]})," and ",(0,s.jsxs)(n.em,{children:["g",(0,s.jsx)("sub",{children:"2"})]})," in the picture above).\nThe fallback would not handle failures due to a timeout.\nFrom this example, you see that the order of middlewares is crucial."]}),"\n",(0,s.jsx)(n.p,{children:"The provided default resilience middlewares should be added in the following order:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"retry"}),"\n",(0,s.jsx)(n.li,{children:"circuit breaker"}),"\n",(0,s.jsx)(n.li,{children:"timeout"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The SAP Cloud SDK provides default resilience middlewares so that you do not have to worry about the details in most cases.\nYou can find detailed information on the resilience topic in a ",(0,s.jsx)(n.a,{href:"../guides/resilience",children:"dedicated documentation"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"use-the-middleware-context",children:"Use the Middleware Context"}),"\n",(0,s.jsx)(n.p,{children:"The previous examples did not use the middleware context.\nHowever, the context provides useful information you can use in your middleware."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"/**\n * Represents the execution context of a middleware.\n */\nexport interface HttpMiddlewareContext {\n  readonly tenantId: string;\n  readonly uri: string;\n  readonly jwt?: string;\n  readonly destinationName?: string;\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"The fallback middleware could consider the URI:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const fallbackMiddleware = options => {\n  return requestConfig => {\n    try {\n      return options.fn(requestConfig);\n    } catch (e) {\n      if (options.context.uri === 'http://system-one.com') {\n        //do something\n      } else {\n        //do something else\n      }\n    }\n  };\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"change-request-parameters",children:"Change Request Parameters"}),"\n",(0,s.jsxs)(n.p,{children:["If you want to change the request parameters you can modify them as well.\nThe SAP Cloud SDK uses the axios client which has a ",(0,s.jsx)(n.code,{children:"timeout"})," property.\nYou could set a timeout on client level like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const clientTimeoutMiddleware = options => {\n  return requestConfig => {\n    return options.fn({ ...requestConfig, timeout: 500 });\n  };\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Another usage for the middleware would be a custom ",(0,s.jsx)(n.code,{children:"CSRF"})," token fetching:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const customCsrf = options => {\n  return async requestConfig => {\n    requestConfig.headers['x-csrf-token'] = await getCsrfToken();\n    return options.fn(requestConfig);\n  };\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Note that you have to disable the ",(0,s.jsx)(n.a,{href:"./connectivity/http-client#csrf-token-fetching",children:"default token fetching"})," if you want to use a custom middleware."]}),"\n",(0,s.jsx)(n.h2,{id:"execution-order-of-middlewares",children:"Execution Order of Middlewares"}),"\n",(0,s.jsx)(n.p,{children:"As discussed in the previous section, the composition order for the new function is from right to left.\nHowever, the composition order does not mimic the order when the code related to the middleware is executed.\nTo illustrate this, consider the four example middlewares below (for simplicity assume that the response and config are just bare strings):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const beforeMiddleware = options => {\n  return requestConfig => options.fn(requestConfig + '/before');\n};\n\nconst afterMiddleware = options => {\n  return requestConfig =>\n    options.fn(requestConfig).then(response => response + '-after');\n};\n"})}),"\n",(0,s.jsx)(n.p,{children:"The first middleware changes something before the method is executed and the second two change the response after the request resolves.\nIf you add these four middlewares to a request"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"executeHttpRequest(\n  { url: 'http://example.com' },\n  {\n    middleware: [beforeMiddleware, afterMiddleware],\n    method: 'get'\n  }\n);\n"})}),"\n",(0,s.jsx)(n.p,{children:"you can work out the resulting function since the middlewares are simple:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"requestConfig => axios.request(requestConfig); //initial function\n\nrequestConfig =>\n  axios.request(requestConfig).then(response => response + '-after'); //afterMiddleware middleware\n\nrequestConfig =>\n  axios\n    .request(requestConfig + '/before')\n    .then(response => response + '-after'); //beforeMiddleware\n"})}),"\n",(0,s.jsx)(n.p,{children:"The middlewares are added from right to left, but changes in the config will happen before the response is adjusted.\nNo matter where the related middlewares were positioned.\nThis becomes clearer if you consider a middleware squaring a result which can be done before or after function execution:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const square = x => x * x;\n\nconst squareMiddlewareAfter = fn => x => fn(x).then(x => square(x)); // equivalent fn => x => square(fn(x))\n\nconst squareMiddlewareBefore = fn => x => fn(x ^ 2); // equivalent fn => x => fn(square(x))\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In one case the resulting function is ",(0,s.jsx)(n.code,{children:"square(fn(x))"})," which is in line with the mathematical composition square \u2218 fn.\nIn the other case it is ",(0,s.jsx)(n.code,{children:"fn(square(x))"})," which is the opposite like the composition."]}),"\n",(0,s.jsx)(n.p,{children:"Note that in practice this difference in behavior does not cause problems:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The ordering is crucial for the middlewares doing something after the request like the resilience.\nFor these the order is expected by the composition: the most left one is executed last.\nMost of the middlewares are of this kind."}),"\n",(0,s.jsx)(n.li,{children:"Middlewares changing the request configuration are rare and in most cases one of them is sufficient.\nEven if you have multiple ones they do not interfere with each other.\nOnly if you have multiple middlewares of this kind changing the same configuration you need to be careful and consider the inverse execution order."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"benefits-of-middlewares",children:"Benefits of Middlewares"}),"\n",(0,s.jsx)(n.p,{children:"You could implement many use cases of middlewares also directly.\nYou could implement a fallback using a global try/catch."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"try {\n  executeHttpRequest(destination, options);\n} catch (e) {\n  //implement fallback logic\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"However, this has two disadvantages:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The first one is more of cosmetic nature.\nThe middlewares encourage you to implement the logic in a separate function which can be reused in different places.\nYour actual business code stays clean.\nThis becomes even more obvious for ",(0,s.jsx)(n.a,{href:"./odata/execute-request",children:"typed clients"})," which represent you business requirements more directly."]}),"\n",(0,s.jsx)(n.li,{children:"The second one is about the position where you can include the code.\nWith the middleware you can include logic directly to the HTTP layer.\nThis is much more powerful than code on the outer layer."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Assume you want to replace the HTTP client of the SAP Cloud SDK with a different one.\nOnly with a middleware this is possible.\nYou have to adjust the request so that it matches your client and the response so that it matches the expected form."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import httpClient from 'some-client-like-node-fetch';\n\nconst replaceHttpClientMiddleware = options => {\n  return request => {\n    const castedRequest = castRequest(options.context.fnArgument);\n    return httpClient(castedRequest).then(response => castResponse(response));\n  };\n};\n"})})]})}function m(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>d});var i=t(96540);const s={},o=i.createContext(s);function r(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);