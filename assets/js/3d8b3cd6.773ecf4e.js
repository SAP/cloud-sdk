"use strict";(self.webpackChunksap_cloud_sdk_documentation=self.webpackChunksap_cloud_sdk_documentation||[]).push([[3620],{54477:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"guides/retrieve-jwt","title":"How to retrieve JSON Web Tokens (JWT)","description":"You\'ll learn how to retrieve a JWT in your application code as well as locally using tools like Postman.","source":"@site/docs-js_versioned_docs/version-v3/guides/how-to-retrieve-jwt.mdx","sourceDirName":"guides","slug":"/guides/retrieve-jwt","permalink":"/cloud-sdk/docs/js/v3/guides/retrieve-jwt","draft":false,"unlisted":false,"editUrl":"https://github.com/SAP/cloud-sdk/edit/main/docs-js_versioned_docs/version-v3/guides/how-to-retrieve-jwt.mdx","tags":[],"version":"v3","frontMatter":{"id":"retrieve-jwt","title":"How to retrieve JSON Web Tokens (JWT)","sidebar_label":"How to retrieve JWTs","description":"You\'ll learn how to retrieve a JWT in your application code as well as locally using tools like Postman.","keywords":["sap","cloud","sdk","cloud native","cloud sdk","sap cloud sdk","JSON web token","JWT"]},"sidebar":"docsJsSidebar","previous":{"title":"How to Add Resilience","permalink":"/cloud-sdk/docs/js/v3/guides/resilience"},"next":{"title":"Remotely debug an application on SAP BTP","permalink":"/cloud-sdk/docs/js/v3/guides/remote-debugging"}}');var i=n(74848),o=n(28453);const r={id:"retrieve-jwt",title:"How to retrieve JSON Web Tokens (JWT)",sidebar_label:"How to retrieve JWTs",description:"You'll learn how to retrieve a JWT in your application code as well as locally using tools like Postman.",keywords:["sap","cloud","sdk","cloud native","cloud sdk","sap cloud sdk","JSON web token","JWT"]},a=void 0,l={},c=[{value:"Overview",id:"overview",level:2},{value:"JWT on SAP BTP",id:"jwt-on-sap-btp",level:2},{value:"Use JWT in Application",id:"use-jwt-in-application",level:2},{value:"Obtain JWT With Postman",id:"obtain-jwt-with-postman",level:2},{value:"Obtain JWT Programmatically",id:"obtain-jwt-programmatically",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(t.p,{children:"A JSON Web Token (JWT) is a standardized object containing some structured information.\nA JWT contains three parts:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Header: Containing meta information like hashing algorithm and verification certificates"}),"\n",(0,i.jsx)(t.li,{children:"Payload: The actual data"}),"\n",(0,i.jsx)(t.li,{children:"Signature: Signature of the Header and Payload for verification"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Given a JWT, you can use the information from the header and signature to check if the JWT is valid.\nTherefore, JWTs are used to exchange authorization and authentication information between applications."}),"\n",(0,i.jsx)(t.h2,{id:"jwt-on-sap-btp",children:"JWT on SAP BTP"}),"\n",(0,i.jsxs)(t.p,{children:["The retrieval of a JWT is done by the approuter together with the XSUAA.\n",(0,i.jsx)(t.a,{href:"https://sap.github.io/cloud-sdk/docs/js/guides/how-to-use-the-approuter",children:"This guide"})," explains these concepts.\nFind a complete setup in the sample applications for ",(0,i.jsx)(t.a,{href:"https://github.com/SAP-samples/cloud-sdk-js/tree/main/samples/cf-sample-application",children:"Cloud Foundry"})," and ",(0,i.jsx)(t.a,{href:"https://github.com/SAP-samples/cloud-sdk-js/tree/main/samples/k8s-sample-application",children:"k8s"}),".\nThe flow is as follows:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"user requests a resource and is not yet authenticated"}),"\n",(0,i.jsx)(t.li,{children:"approuter redirects the request to the identity provider (IdP)"}),"\n",(0,i.jsxs)(t.li,{children:["XSUAA issues a JWT - see ",(0,i.jsx)(t.a,{href:"#obtain-jwt-programmatically",children:"here"})," for details"]}),"\n",(0,i.jsx)(t.li,{children:"approuter adds the JWT to the request headers and redirects the request to the initially requested resource"}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["A JWT issued this way contains a ",(0,i.jsx)(t.code,{children:"JKU"})," header property.\nThis property points to the URL where you can obtain the certificate to verify the JWT.\nThe URL must be from the XSUAA domain so that it is trusted and the JWT validation does not fail."]}),"\n",(0,i.jsxs)(t.p,{children:["Sometimes you want to use a JWT which is not issued by the XSUAA and approuter.\nSuch tokens do not contain a ",(0,i.jsx)(t.code,{children:"JKU"})," at all or a value with a different domain.\nIn this case the SAP Cloud SDK does not validate the token, but the destination service does.\nYou have to set the ",(0,i.jsx)(t.a,{href:"https://help.sap.com/docs/CP_CONNECTIVITY/cca91383641e40ffbe03bdc78f00f681/283cd2d1c72147a18c69daf681650f07.html",children:"destination properties"})," ",(0,i.jsx)(t.code,{children:"x_user_token.jwks"})," or ",(0,i.jsx)(t.code,{children:"x_user_token.jwks_uri"})," to provide the information to verify the custom JWT."]}),"\n",(0,i.jsx)(t.p,{children:"If you use a custom JWT without the approuter and XSUAA service, it is your responsibility to do the access control in the application."}),"\n",(0,i.jsx)(t.admonition,{type:"caution",children:(0,i.jsx)(t.p,{children:"A JWT has a limited lifetime but is nevertheless a sensitive security object.\nDo not log complete JWTs in the application, share them with others, or use online tools to decode them."})}),"\n",(0,i.jsx)(t.h2,{id:"use-jwt-in-application",children:"Use JWT in Application"}),"\n",(0,i.jsx)(t.p,{children:"After the JWT was issued, it is added to the request headers by the approuter:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'{\n  "headers": {\n    "authorization": "Bearer yourJwtTokenBase64Encoded"\n  }\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["The SAP Cloud SDK has a convenience function to extract the JWT from the request object.\nFor ",(0,i.jsx)(t.a,{href:"https://nestjs.com/",children:"NestJS"}),", the code would look like:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",children:"import { Controller, Get, Req } from '@nestjs/common';\nimport { Request } from 'express';\nimport { retrieveJwt } from '@sap-cloud-sdk/connectivity';\n\n@Controller()\nexport class AppController {\n  constructor() {}\n\n  @Get('some-sample-endpoint')\n  getSomeSampleEndpoint(@Req() request: Request): Promise<void> {\n    const myJwt = retrieveJwt(request);\n    //Do something with the JWT e.g. fetch some data using a destination\n  }\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Note, that the SAP Cloud SDK uses the ",(0,i.jsx)(t.code,{children:"IncomingMessage"})," object from node, which is compatible to the request object of common frameworks like ",(0,i.jsx)(t.a,{href:"https://expressjs.com/",children:"express"})," or ",(0,i.jsx)(t.a,{href:"https://nestjs.com/",children:"NestJs"}),".\nIn case you use a different framework, the ",(0,i.jsx)(t.a,{href:"https://github.com/SAP/cloud-sdk-js/blob/6e3453e50a061d3ea2dbd9ac6a40232e624f348f/packages/connectivity/src/scp-cf/jwt.ts#L45-L63",children:"implementation"})," in the ",(0,i.jsx)(t.code,{children:"retrieveJwt()"})," is simple.\nEffectively it takes ",(0,i.jsx)(t.code,{children:"authorization"})," header value and extracts the token value."]}),"\n",(0,i.jsxs)(t.p,{children:["You can use the JWT to call the destination service or make a request against a destination directly.\nNote, that the destination service performs token exchange flows for you, if configured accordingly.\nThis means the initial JWT is transformed to a ",(0,i.jsx)(t.code,{children:"SAMLBearerAssertion"})," or ",(0,i.jsx)(t.code,{children:"ClientCredentials"})," grant."]}),"\n",(0,i.jsx)(t.h2,{id:"obtain-jwt-with-postman",children:"Obtain JWT With Postman"}),"\n",(0,i.jsx)(t.p,{children:"For a faster feedback cycle, it is convenient to test things locally without deployment to the SAP BTP.\nIn some cases, applications rely on a JWT to set scopes or propagate a user to external systems.\nIn such a case, you can obtain the JWT using Postman:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"Create a new request"}),"\n",(0,i.jsxs)(t.li,{children:["Go to the ",(0,i.jsx)(t.strong,{children:"Authorization"})," tab of the request"]}),"\n",(0,i.jsxs)(t.li,{children:["Select ",(0,i.jsx)(t.strong,{children:"OAuth 2.0"})," as a type"]}),"\n",(0,i.jsxs)(t.li,{children:["Fill the following values in the user interface:","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"Callback URL"}),": Path to the application protected by the XSUAA"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"Auth URL"}),": Path to the authentication endpoint using your subdomain and the values for the callback URL e.g. ",(0,i.jsx)(t.code,{children:"https://<subdomain>.authentication.sap.hana.ondemand.com/oauth/authorize?redirect_uri=<callbackUrl>"})]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"Token URL"}),": Path to the token endpoint using your subdomain, e.g., ",(0,i.jsx)(t.code,{children:"https://<subdomain>.authentication.sap.hana.ondemand.com/oauth/token"})]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"Client ID"})," and ",(0,i.jsx)(t.code,{children:"Client secret"})," for the XSUAA service (either VCAP variables or service keys)"]}),"\n",(0,i.jsxs)(t.li,{children:["Uncheck ",(0,i.jsx)(t.strong,{children:"Authorize using browser"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["Press ",(0,i.jsx)(t.strong,{children:"Get new access token"})," to retrieve a token"]}),"\n",(0,i.jsx)(t.li,{children:"Postman will open a window showing the IdP login form"}),"\n",(0,i.jsx)(t.li,{children:"Enter username and password"}),"\n",(0,i.jsx)(t.li,{children:"Postman shows the retrieved token that you can copy"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Cookies will remember the entered username and password.\nThis makes re-fetching a token faster when your old token expires.\nRemove the cookies in case you want to start fresh."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:n(72645).A+"",width:"1526",height:"852"})}),"\n",(0,i.jsx)(t.h2,{id:"obtain-jwt-programmatically",children:"Obtain JWT Programmatically"}),"\n",(0,i.jsx)(t.p,{children:"In some situations, it is necessary to retrieve a JWT programmatically:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Retrieve a ",(0,i.jsx)(t.code,{children:"code"})," from the XSUAA"]}),"\n",(0,i.jsxs)(t.li,{children:["Initial ",(0,i.jsx)(t.code,{children:"GET"})," request on XSUAA: ",(0,i.jsx)(t.code,{children:"https://<xsuaaUrl>/oauth/authorize?client_id=<clientId>&redirect_uri=<redirectUri>&response_type=code"})]}),"\n",(0,i.jsx)(t.li,{children:"This will provide cookies for all upcoming XSUAA requests."}),"\n",(0,i.jsxs)(t.li,{children:["Retrieve a SAML request from the XSUAA: ",(0,i.jsx)(t.code,{children:"https://<xsuaaUrl>/saml/login/alias/<subdomain>.<host>"})]}),"\n",(0,i.jsxs)(t.li,{children:["Transform the SAML request into a SAML response via the IdP.\nThis involves multiple redirected requests with a lot of cookies and request parameters passed around.\nIn the browser redirects with the ",(0,i.jsx)(t.code,{children:"set-cookie"})," and ",(0,i.jsx)(t.code,{children:"location"})," headers work well.\nIn node, most HTTP clients do not handle the redirects correctly and a manual redirect on 302 response needs to be implemented."]}),"\n",(0,i.jsxs)(t.li,{children:["Once you have the SAML response, call the XSUAA to retrieve the ",(0,i.jsx)(t.code,{children:"code"})," in the location header."]}),"\n",(0,i.jsxs)(t.li,{children:["Use the ",(0,i.jsx)(t.code,{children:"code"})," with clientId and clientSecret to get a JWT token from the XSUAA service."]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"In case you also need an implementation, investigate the steps in the debug console of your browser when you login."})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},72645:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/postman-oauth-token-4c6a2e98609bc91d63ffa4677afa9880.png"},28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>a});var s=n(96540);const i={},o=s.createContext(i);function r(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);