"use strict";(self.webpackChunksap_cloud_sdk_documentation=self.webpackChunksap_cloud_sdk_documentation||[]).push([[9126],{62294:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>r,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"features/connectivity/mtls","title":"Certificate-Based Authentication Using SAP Cloud SDK","description":"This article describes how the SAP Cloud SDK for Java can be used to establish connections to other cloud services using mTLS","source":"@site/docs-java/features/connectivity/007-mtls.mdx","sourceDirName":"features/connectivity","slug":"/features/connectivity/mtls","permalink":"/cloud-sdk/docs/java/features/connectivity/mtls","draft":false,"unlisted":false,"editUrl":"https://github.com/SAP/cloud-sdk/edit/main/docs-java/features/connectivity/007-mtls.mdx","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"id":"mtls","title":"Certificate-Based Authentication Using SAP Cloud SDK","hide_title":false,"hide_table_of_contents":false,"sidebar_label":"Certificate-based Authentication","description":"This article describes how the SAP Cloud SDK for Java can be used to establish connections to other cloud services using mTLS","keywords":["sap","cloud","sdk","mTLS","java","connectivity"]},"sidebar":"docsJavaSidebar","previous":{"title":"Running Locally","permalink":"/cloud-sdk/docs/java/features/connectivity/running-locally"},"next":{"title":"Transparent Proxy","permalink":"/cloud-sdk/docs/java/features/connectivity/transparent-proxy"}}');var c=i(74848),o=i(28453);const s={id:"mtls",title:"Certificate-Based Authentication Using SAP Cloud SDK",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Certificate-based Authentication",description:"This article describes how the SAP Cloud SDK for Java can be used to establish connections to other cloud services using mTLS",keywords:["sap","cloud","sdk","mTLS","java","connectivity"]},a=void 0,r={},d=[{value:"Why Certificate-Based Authentication (mTLS)",id:"why-certificate-based-authentication-mtls",level:2},{value:"Shortcomings of Using Secret for Token Retrieval",id:"shortcomings-of-using-secret-for-token-retrieval",level:2},{value:"Certificate-Based Authentication for Services",id:"certificate-based-authentication-for-services",level:2},{value:"Default Validity Period of Certificates",id:"default-validity-period-of-certificates",level:2},{value:"Extending the Validity of a Certificate",id:"extending-the-validity-of-a-certificate",level:3},{value:"Sticking to Using Secret for Token Retrieval",id:"sticking-to-using-secret-for-token-retrieval",level:3},{value:"Using Automated Certificate Rotation using the Zero Trust Identity Service (SAP-internal)",id:"using-automated-certificate-rotation-using-the-zero-trust-identity-service-sap-internal",level:2},{value:"Configuring your Application to use ZTIS",id:"configuring-your-application-to-use-ztis",level:3},{value:"Integration with Identity Authentication Service (IAS)",id:"integration-with-identity-authentication-service-ias",level:3},{value:"Developing Locally",id:"developing-locally",level:3}];function l(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(t.admonition,{type:"note",children:(0,c.jsxs)(t.p,{children:["This article talks about using mTLS to connect with cloud services like ",(0,c.jsx)(t.code,{children:"XSUAA"})," or ",(0,c.jsx)(t.code,{children:"Destination"})," service.\nIf you are interested in using mTLS for communication between your application and target destination, please refer ",(0,c.jsx)(t.a,{href:"/cloud-sdk/docs/java/features/connectivity/destination-service#enabling-mtls-for-application-to-destination-communication",children:"here"})," instead."]})}),"\n",(0,c.jsxs)(t.p,{children:["The SAP Cloud SDK supports certificate-based authentication while establishing connections to other cloud services like ",(0,c.jsx)(t.code,{children:"XSUAA"})," or ",(0,c.jsx)(t.code,{children:"Destination"})," service."]}),"\n",(0,c.jsx)(t.h2,{id:"why-certificate-based-authentication-mtls",children:"Why Certificate-Based Authentication (mTLS)"}),"\n",(0,c.jsxs)(t.p,{children:["Mutual ",(0,c.jsx)(t.code,{children:"TLS"})," or ",(0,c.jsx)(t.code,{children:"mTLS"})," for short is a method for mutual authentication.\nIt ensures that before proceeding with the ",(0,c.jsx)(t.code,{children:"HTTP"})," exchange both the client and the server each mutually verify each other's identities by the use of ",(0,c.jsx)(t.code,{children:"X.509"})," certificates.\nUsing certificate-based authentication ensures overcoming the shortcomings of authenticating with ",(0,c.jsx)(t.code,{children:"clientsecret"}),"."]}),"\n",(0,c.jsx)(t.h2,{id:"shortcomings-of-using-secret-for-token-retrieval",children:"Shortcomings of Using Secret for Token Retrieval"}),"\n",(0,c.jsxs)(t.p,{children:["Let's take an example of a service or an application protected by ",(0,c.jsx)(t.a,{href:"https://help.sap.com/viewer/65de2977205c403bbc107264b8eccf4b/Cloud/en-US/6373bb7a96114d619bfdfdc6f505d1b9.html",children:(0,c.jsx)(t.code,{children:"XSUAA"})}),".\nTo access the service or application, you'll need a ",(0,c.jsx)(t.code,{children:"JWT"}),".\nYou will usually fetch a ",(0,c.jsx)(t.code,{children:"JWT"})," by providing ",(0,c.jsx)(t.code,{children:"clientid"}),", ",(0,c.jsx)(t.code,{children:"clientsecret"})," and ",(0,c.jsx)(t.code,{children:"uri"})," stored in your service binding to run a ",(0,c.jsx)(t.a,{href:"https://github.com/SAP/cloud-security-xsuaa-integration/tree/main/token-client",children:(0,c.jsx)(t.code,{children:"token retrieval flow"})})," say for e.g. ",(0,c.jsx)(t.code,{children:"client"})]}),"\n",(0,c.jsxs)(t.p,{children:["The use of ",(0,c.jsx)(t.code,{children:"clientsecret"})," has an inherent risk of these credentials being leaked, especially as they are not frequently rotated.\nLeaking these credentials into the hands of an attacker can cause a lot of harm and stay long unnoticed.\nThe use of certificate-based authentication to fetch the ",(0,c.jsx)(t.code,{children:"JWT"})," from ",(0,c.jsx)(t.code,{children:"XSUAA"})," significantly reduces the risk of leaking secrets and makes rotating them easier."]}),"\n",(0,c.jsxs)(t.admonition,{type:"note",children:[(0,c.jsx)(t.p,{children:"The SAP Cloud SDK automatically"}),(0,c.jsxs)(t.ul,{children:["\n",(0,c.jsxs)(t.li,{children:["Fetches the ",(0,c.jsx)(t.code,{children:"JWT"})," for you"]}),"\n",(0,c.jsxs)(t.li,{children:["Adds the fetched ",(0,c.jsx)(t.code,{children:"JWT"})," to the ",(0,c.jsx)(t.code,{children:"Authorization"})," header when requesting a service to ensure that the request gets authenticated and authorized."]}),"\n"]}),(0,c.jsx)(t.p,{children:"Application developers do not need to worry about doing any of this themselves."})]}),"\n",(0,c.jsx)(t.h2,{id:"certificate-based-authentication-for-services",children:"Certificate-Based Authentication for Services"}),"\n",(0,c.jsxs)(t.p,{children:["To adhere to the latest recommended security best practices by SAP, some re-use and kernel services have enabled certificate-based authentication.\nAs a consequence, SAP Cloud SDK also supports certificate-based authentication while accessing these services.\nIf a service binding has a property ",(0,c.jsx)(t.code,{children:"credentials: { credential-type: x509 }"})," then this is an indication that you can use certificate-based authentication to access the service."]}),"\n",(0,c.jsxs)(t.p,{children:[(0,c.jsx)(t.code,{children:"XSUAA"})," service is one of the services that has enabled certificate-based authentication.\nThis means that in the service binding in addition to the ",(0,c.jsx)(t.code,{children:"client_secret"})," you will also find ",(0,c.jsx)(t.code,{children:"certificate"})," and ",(0,c.jsx)(t.code,{children:"key"})," entries now.\nExample:"]}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-json",children:'{\n    "VCAP_SERVICES": {\n\t\t"xsuaa": [\n\t\t\t{\n\t\t\t\t"label": "xsuaa",\n\t\t\t\t...\n\t\t\t\t"credentials": {\n\t\t\t\t    ...\n\t\t\t\t    "credential-type": "x509"\n\t\t\t\t\t"clientid": "fictional-client-id",\n\t\t\t\t\t"clientsecret": "fictional-secret",\n\t\t\t\t\t"certificate": "-----BEGIN CERTIFICATE-----fictional-certificate-----END CERTIFICATE-----\\n",\n\t\t\t\t\t"key": "key"\n\t\t\t\t\t...\n\t\t\t\t},\n\t\t\t}\n\t\t]\n\t}\n}\n'})}),"\n",(0,c.jsxs)(t.p,{children:["This certificate would now be used in place of ",(0,c.jsx)(t.code,{children:"clientsecret"})," to obtain the ",(0,c.jsx)(t.code,{children:"JWT"})," using ",(0,c.jsxs)(t.a,{href:"https://github.com/SAP/cloud-security-xsuaa-integration/tree/main/token-client",children:[(0,c.jsx)(t.code,{children:"XSUAA"})," token retrieval flows"]}),".\nThe SAP Cloud SDK will as before fetch the ",(0,c.jsx)(t.code,{children:"JWT"})," for you.\nThe only difference is that the ",(0,c.jsx)(t.code,{children:"certificate"})," from your service binding is used to authenticate the client."]}),"\n",(0,c.jsx)(t.h2,{id:"default-validity-period-of-certificates",children:"Default Validity Period of Certificates"}),"\n",(0,c.jsxs)(t.p,{children:["The ",(0,c.jsx)(t.code,{children:"X.509"})," certificates used in the service binding could either be external or ",(0,c.jsx)(t.code,{children:"XSUAA"})," managed.\nBy default ",(0,c.jsx)(t.code,{children:"XSUAA"})," managed certificates are valid only for ",(0,c.jsx)(t.strong,{children:"7 days"}),".\nYour calls to the ",(0,c.jsx)(t.code,{children:"XSUAA"})," to fetch a ",(0,c.jsx)(t.code,{children:"JWT"})," will fail after your certificate expires."]}),"\n",(0,c.jsx)(t.p,{children:"You can verify this by looking at the logs of your application, you should see"}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{children:"[APP/PROC/WEB/0] OUT Caused by: com.sap.cloud.sdk.cloudplatform.security.exception.TokenRequestFailedException:\ncom.sap.cloud.security.xsuaa.tokenflows.TokenFlowException:\nError requesting technical user token with grant_type 'client_credentials':\nError retrieving JWT token. Server URI https://<subdomain>.authentication.cert.<landscape domain>/oauth/token.\nHttp status code 400. Response body '400 Bad Request: TLS handshake failed.\n\n[APP/PROC/WEB/0] OUT ssl_c_err: X509_V_ERR_CERT_HAS_EXPIRED\n"})}),"\n",(0,c.jsxs)(t.p,{children:["Don't get confused with the grant_type of ",(0,c.jsx)(t.code,{children:"client_credentials"})," in the log, this is expected."]}),"\n",(0,c.jsxs)(t.p,{children:["For ",(0,c.jsx)(t.code,{children:"X.509"})," certificate-based authentication, the token retrieval end point will look like\n",(0,c.jsx)(t.code,{children:"https://<subdomain>.authentication.cert.<landscape domain>/oauth/token"}),".\nNotice that the endpoint contains ",(0,c.jsx)(t.strong,{children:"cert"})," ."]}),"\n",(0,c.jsxs)(t.p,{children:["For authentication based on ",(0,c.jsx)(t.code,{children:"clientsecret"}),", the end point would have looked like: ",(0,c.jsx)(t.code,{children:"https://<subdomain>.authentication.<landscape domain>/oauth/token"})]}),"\n",(0,c.jsx)(t.admonition,{title:"certificate renewal process",type:"caution",children:(0,c.jsx)(t.p,{children:"To obtain a new certificate, you will have to delete and re-create a service binding.\nThe application also needs to be restarted to use the updated service binding."})}),"\n",(0,c.jsx)(t.h3,{id:"extending-the-validity-of-a-certificate",children:"Extending the Validity of a Certificate"}),"\n",(0,c.jsxs)(t.p,{children:["For less frequent certificate rotation you can extend its validity to a maximum of 1 year.\nFor the ",(0,c.jsx)(t.code,{children:"XSUAA"})," managed certificate use parameters below while creating a service ",(0,c.jsx)(t.strong,{children:"binding"}),"."]}),"\n",(0,c.jsx)(t.p,{children:(0,c.jsx)(t.code,{children:"cf bind-service myapp myservice -c parameters.json"})}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-json",children:'{\n  "credential-type": "x509",\n  "x509": {\n    "key-length": 2048,\n    "validity": 365,\n    "validity-type": "DAYS"\n  }\n}\n'})}),"\n",(0,c.jsx)(t.admonition,{type:"note",children:(0,c.jsx)(t.p,{children:"With longer certificate validity there is a danger that compromised certificate might go unnoticed for a significant period of time.\nThis significantly increases potential damage to a compromised system."})}),"\n",(0,c.jsx)(t.h3,{id:"sticking-to-using-secret-for-token-retrieval",children:"Sticking to Using Secret for Token Retrieval"}),"\n",(0,c.jsxs)(t.p,{children:["If you prefer to continue using ",(0,c.jsx)(t.strong,{children:"clientSecret"})," instead of ",(0,c.jsx)(t.strong,{children:"Certificate-based Authentication"}),", make sure your ",(0,c.jsx)(t.code,{children:"xs-security.json"})," contains the ",(0,c.jsx)(t.code,{children:"instance-secret"})," as the first entry in the property ",(0,c.jsx)(t.code,{children:"credential-types"}),"."]}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-json",children:'"oauth2-configuration": {\n  "credential-types": ["instance-secret"]\n}\n'})}),"\n",(0,c.jsx)(t.h2,{id:"using-automated-certificate-rotation-using-the-zero-trust-identity-service-sap-internal",children:"Using Automated Certificate Rotation using the Zero Trust Identity Service (SAP-internal)"}),"\n",(0,c.jsx)(t.p,{children:"For SAP-internal development teams the Zero Trust Identity Service (ZTIS) provides a way to automate the certificate rotation process."}),"\n",(0,c.jsx)(t.h3,{id:"configuring-your-application-to-use-ztis",children:"Configuring your Application to use ZTIS"}),"\n",(0,c.jsx)(t.p,{children:"This guide covers how you can configure and use the SAP Cloud SDK to use certificates provided by ZTIS for certificate-based authentication."}),"\n",(0,c.jsxs)(t.admonition,{title:"Prerequisites for using ZTIS",type:"note",children:[(0,c.jsx)(t.p,{children:"The following prerequisites are required to use ZTIS:"}),(0,c.jsxs)(t.ul,{children:["\n",(0,c.jsx)(t.li,{children:"You are deploying an application on Cloud Foundry"}),"\n",(0,c.jsx)(t.li,{children:"You have assigned the required entitlement for using ZTIS to your subaccount"}),"\n",(0,c.jsxs)(t.li,{children:["You have created a service instance of ",(0,c.jsx)(t.code,{children:"zero-trust-identity"})," in your Cloud Foundry space"]}),"\n",(0,c.jsx)(t.li,{children:"You have bound the ZTIS service instance to your application"}),"\n",(0,c.jsxs)(t.li,{children:["You have added the ",(0,c.jsx)(t.code,{children:"zero_trust_sidecar_buildpack"})," as an additional buildpack for your application"]}),"\n"]}),(0,c.jsxs)(t.p,{children:["Head over to the ",(0,c.jsx)(t.a,{href:"https://pages.github.tools.sap/pse/pse-docs/docs/identity/",children:"official documentation"}),", the ",(0,c.jsx)(t.a,{href:"https://github.tools.sap/pse/blueprints/blob/main/examples/cf/ZTIS_Reference.md",children:"reference manual"})," and ",(0,c.jsx)(t.a,{href:"https://github.tools.sap/pse/blueprints/tree/main/examples/cf/java/ztis-identity/cf-manifest",children:"sample code"})," to learn more about how to use ZTIS."]})]}),"\n",(0,c.jsxs)(t.p,{children:["To enable support by SAP Cloud SDK for certificates provided by ZTIS in your application, you need to add the following dependency to your ",(0,c.jsx)(t.code,{children:"pom.xml"}),":"]}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-xml",children:"<dependency>\n\t<groupId>com.sap.cloud.sdk.cloudplatform</groupId>\n\t<artifactId>connectivity-ztis</artifactId>\n</dependency>\n"})}),"\n",(0,c.jsxs)(t.p,{children:["With this dependency you can create a new or modify an existing ",(0,c.jsx)(t.code,{children:"HttpDestination"})," to use the certificate provided by ZTIS."]}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-java",children:'var ks = ZeroTrustIdentityService.getInstance().getOrCreateKeyStore();\n\nvar newDestination = DefaultHttpDestination.builder("https://foo.com")\n\t.keyStore(ks)\n\t.build();\nvar enhancedDestination = DefaultHttpDestination.fromDestination(DestinationAccessor.getDestination("myDestination"))\n\t.keyStore(ks)\n\t.build();\n'})}),"\n",(0,c.jsx)(t.h3,{id:"integration-with-identity-authentication-service-ias",children:"Integration with Identity Authentication Service (IAS)"}),"\n",(0,c.jsx)(t.p,{children:"The SAP Cloud SDK also supports using certificates provided by ZTIS to authenticate to the Identity Authentication Service (IAS)."}),"\n",(0,c.jsxs)(t.p,{children:["This works fully out of the box if you have an instance of IAS with the corresponding credential type ",(0,c.jsx)(t.code,{children:"X509_ATTESTED"})," configured.\nFor more details please refer to the documentation on ",(0,c.jsx)(t.a,{href:"/docs/java/features/connectivity/service-bindings",children:"connecting to services"}),"."]}),"\n",(0,c.jsx)(t.h3,{id:"developing-locally",children:"Developing Locally"}),"\n",(0,c.jsxs)(t.p,{children:["On Cloud Foundry the ",(0,c.jsx)(t.code,{children:"zero_trust_sidecar_buildpack"})," adds a sidecar to your application that fetches the certificates from ZTIS.\nWhen developing locally this sidecar is usually not available."]}),"\n",(0,c.jsxs)(t.p,{children:["To develop locally you can instead store the certificate and key on your local file system.\nDownload the certificate and key from a running instance of your application on Cloud Foundry via ",(0,c.jsx)(t.code,{children:"cf ssh"}),":"]}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-shell",children:'cf ssh <app-name> -c "/home/vcap/deps/0/bin/spire-agent api fetch -socketPath /tmp/spire-agent/public/api.sock -write /tmp/"\ncf ssh <app-name> -c "cat /tmp/svid.0.pem" > /path/to/certificate.pem\ncf ssh <app-name> -c "cat /tmp/svid.0.key" > /path/to/key.key\n'})}),"\n",(0,c.jsx)(t.p,{children:"You then need to provide the paths to the certificate and key with a service binding locally."}),"\n",(0,c.jsxs)(t.p,{children:["For example, you can locally create the ",(0,c.jsx)(t.code,{children:"VCAP_SERVICES"})," environment variable with the following content:"]}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-json",children:'{\n  "zero-trust-identity": [\n    {\n      "label": "zero-trust-identity",\n      "credentials": {\n        "certPath": "/path/to/certificate.pem",\n        "keyPath": "/path/to/key.key"\n      }\n    }\n  ]\n}\n'})}),"\n",(0,c.jsx)(t.p,{children:"Alternatively, you can set the service binding programmatically:"}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-java",children:'new DefaultServiceBindingBuilder()\n\t.withServiceIdentifier(ZTIS_IDENTIFIER)\n\t.withCredentials(Map.of(\n            "certPath", "/path/to/certificate.pem",\n            "keyPath", "/path/to/key.key"))\n\t.build();\n\n// in case you only need this one service binding the following code is fine:\nDefaultServiceBindingAccessor.setInstance(() -> List.of(binding));\n'})}),"\n",(0,c.jsxs)(t.p,{children:["You can read more about how to create service bindings for local development ",(0,c.jsx)(t.a,{href:"/docs/java/features/connectivity/service-bindings#local-development",children:"here"}),"."]})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,c.jsx)(t,{...e,children:(0,c.jsx)(l,{...e})}):l(e)}},28453:(e,t,i)=>{i.d(t,{R:()=>s,x:()=>a});var n=i(96540);const c={},o=n.createContext(c);function s(e){const t=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:s(e.components),n.createElement(o.Provider,{value:t},e.children)}}}]);