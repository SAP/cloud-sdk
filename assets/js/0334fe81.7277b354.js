"use strict";(self.webpackChunksap_cloud_sdk_documentation=self.webpackChunksap_cloud_sdk_documentation||[]).push([[93467],{29824:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>c,default:()=>l,frontMatter:()=>o,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"features/connectivity/destination-cache","title":"Destination Cache and Isolation","description":"This article describes how destinations are cached and how the cache entries are isolated with respect to tenants and users.","source":"@site/docs-js_versioned_docs/version-v3/features/connectivity/destination-cache-isolation.mdx","sourceDirName":"features/connectivity","slug":"/features/connectivity/destination-cache","permalink":"/cloud-sdk/docs/js/v3/features/connectivity/destination-cache","draft":false,"unlisted":false,"editUrl":"https://github.com/SAP/cloud-sdk/edit/main/docs-js_versioned_docs/version-v3/features/connectivity/destination-cache-isolation.mdx","tags":[],"version":"v3","frontMatter":{"id":"destination-cache","title":"Destination Cache and Isolation","hide_title":false,"hide_table_of_contents":false,"sidebar_label":"Destination Cache","description":"This article describes how destinations are cached and how the cache entries are isolated with respect to tenants and users.","keywords":["sap","cloud","sdk","destination","connectivity","caching","isolation","JavaScript","TypeScript"]},"sidebar":"docsJsSidebar","previous":{"title":"Destinations","permalink":"/cloud-sdk/docs/js/v3/features/connectivity/destinations"},"next":{"title":"Proxies","permalink":"/cloud-sdk/docs/js/v3/features/connectivity/proxies"}}');var s=t(74848),a=t(28453);const o={id:"destination-cache",title:"Destination Cache and Isolation",hide_title:!1,hide_table_of_contents:!1,sidebar_label:"Destination Cache",description:"This article describes how destinations are cached and how the cache entries are isolated with respect to tenants and users.",keywords:["sap","cloud","sdk","destination","connectivity","caching","isolation","JavaScript","TypeScript"]},c=void 0,r={},d=[{value:"Destination Cache",id:"destination-cache",level:2},{value:"Cache Expiration",id:"cache-expiration",level:3},{value:"Isolation Strategy",id:"isolation-strategy",level:3},{value:"Changing Isolation Strategy",id:"changing-isolation-strategy",level:3},{value:"Custom Destination Cache",id:"custom-destination-cache",level:2},{value:"Registered Destination Cache",id:"registered-destination-cache",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"To reduce the number of calls to fetch destinations, the SAP Cloud SDK provides an option to cache destinations."}),"\n",(0,s.jsxs)(n.p,{children:["This guide explains how destinations are cached and shows options for destination cache configuration.\nThe general destination lookup is described in ",(0,s.jsx)(n.a,{href:"/cloud-sdk/docs/js/v3/features/connectivity/destinations",children:"this guide"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["All options discussed in the following are part of the ",(0,s.jsx)(n.a,{href:"pathname:///api/v3/interfaces/sap-cloud-sdk_connectivity.DestinationFetchOptions.html",children:(0,s.jsx)(n.code,{children:"DestinationFetchOptions"})}),".\nYou use those options when:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["executing requests through a generated client using ",(0,s.jsx)(n.code,{children:"execute()"})]}),"\n",(0,s.jsxs)(n.li,{children:["executing generic HTTP requests using ",(0,s.jsx)(n.a,{href:"pathname:///api/v3/functions/sap-cloud-sdk_http_client.executeHttpRequest.html",children:(0,s.jsx)(n.code,{children:"executeHttpRequest()"})})]}),"\n",(0,s.jsxs)(n.li,{children:["retrieving destinations using ",(0,s.jsx)(n.a,{href:"pathname:///api/v3/functions/sap-cloud-sdk_connectivity.getDestination.html",children:(0,s.jsx)(n.code,{children:"getDestination()"})})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The following examples will use ",(0,s.jsx)(n.code,{children:"execute()"})," for brevity, but could be replaced by all of the above."]}),"\n",(0,s.jsx)(n.h2,{id:"destination-cache",children:"Destination Cache"}),"\n",(0,s.jsxs)(n.p,{children:["By default, destination caching is disabled.\nEnable it by setting the ",(0,s.jsx)(n.a,{href:"pathname:///api/v3/interfaces/sap-cloud-sdk_connectivity.DestinationFetchOptions.html#useCache",children:(0,s.jsx)(n.code,{children:"useCache"})})," option to ",(0,s.jsx)(n.code,{children:"true"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:".execute({ destinationName: 'DESTINATION', jwt: 'JWT', useCache: true })\n"})}),"\n",(0,s.jsx)(n.p,{children:"The destination cache holds destinations that potentially require HTTP requests, i.e.:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"destinations that were retrieved from the destination service (requires HTTP request to the destination service)"}),"\n",(0,s.jsx)(n.li,{children:"destinations from service bindings (potentially requires HTTP request for authentication flow)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Registered destinations and destinations from environment variables are not held in the destination cache."}),"\n",(0,s.jsx)(n.h3,{id:"cache-expiration",children:"Cache Expiration"}),"\n",(0,s.jsxs)(n.p,{children:["Destinations include authorization information and therefore should not be cached limitlessly.\nThe cache expiration time depends on the ",(0,s.jsx)(n.a,{href:"/cloud-sdk/docs/js/v3/features/connectivity/destinations#authentication-and-json-web-token-retrieval",children:"authentication type"})," of the destination:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"If the destination includes an authorization token, the cache expires at the expiration time of the authorization token."}),"\n",(0,s.jsxs)(n.li,{children:["Otherwise the cache expires after 5 minutes (e.g. ",(0,s.jsx)(n.code,{children:"BasicAuthentication"})," or ",(0,s.jsx)(n.code,{children:"ClientCertificateAuthentication"}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"isolation-strategy",children:"Isolation Strategy"}),"\n",(0,s.jsx)(n.p,{children:"Cached destinations should only be available to authorized parties and therefore need to be isolated on user and/or tenant level.\nThe SAP Cloud SDK provides two options for destination cache isolation:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"tenant"}),": Destinations are isolated on tenant level.\nDifferent users on the same tenant hit the same cache entries for the same destination name."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"tenant-user"}),": Destinations are cached separately for each user and tenant.\nDifferent users on the same tenant hit different cache entries for the same destination name.\nThe same user hits different chache entries on different tenants."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The default cache isolation strategy depends on the provided JWT:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["no JWT: Isolation is set to ",(0,s.jsx)(n.code,{children:"tenant"}),".\nThe value for the tenant is the provider account tenant."]}),"\n",(0,s.jsxs)(n.li,{children:["JWT without ",(0,s.jsx)(n.code,{children:"user_id"}),": Isolation is set to ",(0,s.jsx)(n.code,{children:"tenant"}),".\nThe value for the tenant is the ",(0,s.jsx)(n.code,{children:"zid"})," property of the JWT."]}),"\n",(0,s.jsxs)(n.li,{children:["JWT with ",(0,s.jsx)(n.code,{children:"user_id"}),": Isolation is set to ",(0,s.jsx)(n.code,{children:"tenant-user"}),".\nThe and values are taken from ",(0,s.jsx)(n.code,{children:"zid"})," and ",(0,s.jsx)(n.code,{children:"user_id"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The first two cases (no JWT and JWT wihout ",(0,s.jsx)(n.code,{children:"user_id"}),") are typical for user-independent authentication types, like ",(0,s.jsx)(n.code,{children:"BasicAuthentication"}),", ",(0,s.jsx)(n.code,{children:"ClientCertificateAuthentication"})," or ",(0,s.jsx)(n.code,{children:"OAuth2ClientCredentials"}),".\nThis is a safe choice which prevents privilege escalation due to caching."]}),"\n",(0,s.jsx)(n.h3,{id:"changing-isolation-strategy",children:"Changing Isolation Strategy"}),"\n",(0,s.jsx)(n.p,{children:"There are cases where the default isolation strategy is not optimal.\nAssume you have a multi-tenant scenario, where you pass a JWT to obtain the destination for the respective tenant."}),"\n",(0,s.jsxs)(n.p,{children:["The JWT contains a ",(0,s.jsx)(n.code,{children:"user_id"})," but the authentication type of the destination is user-independent.\nThe default isolation strategy for this case is ",(0,s.jsx)(n.code,{children:"tenant-user"}),", although ",(0,s.jsx)(n.code,{children:"tenant"})," would suffice."]}),"\n",(0,s.jsxs)(n.p,{children:["For such cases, you can manually enforce weaker isolation by passing the ",(0,s.jsx)(n.a,{href:"pathname:///api/v3/interfaces/sap-cloud-sdk_connectivity.DestinationFetchOptions.html#isolationStrategy",children:(0,s.jsx)(n.code,{children:"isolationStrategy"})})," option:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:".execute({\n  destinationName: 'DESTINATION',\n  jwt: 'JWT',\n  isolationStrategy: 'tenant'\n})\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"caution",children:(0,s.jsxs)(n.p,{children:["Be very careful with this option.\nYou should know what you're doing when manually downgrading the isolation strategy from ",(0,s.jsx)(n.code,{children:"tenant-user"})," level.\nAn erroneous configuration can have severe consequences like privilege escalation between users."]})}),"\n",(0,s.jsx)(n.h2,{id:"custom-destination-cache",children:"Custom Destination Cache"}),"\n",(0,s.jsxs)(n.p,{children:["When caching is enabled, destinations are cached in-memory.\nIf you need more control over the destination cache, e.g. to use a persistent or distributed cache, you can create a custom destination cache.\nFor this, implement the ",(0,s.jsx)(n.a,{href:"pathname:///api/v3/interfaces/sap-cloud-sdk_connectivity.DestinationCacheInterface.html",children:(0,s.jsx)(n.code,{children:"DestinationCacheInterface"})}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"export interface DestinationCacheInterface {\n  /**\n   * This is called when an entry is added to the cache.\n   * @param key - The cache key to store the item under.\n   * @param item - The destination alongside an expiration time to store in the cache.\n   */\n  set(key: string | undefined, item: CacheEntry<Destination>): Promise<void>;\n  /**\n   * This is called when an entry shall be retrieved from the cache.\n   * @param key - The cache key the item is stored under.\n   */\n  get(key: string | undefined): Promise<Destination | undefined>;\n  /**\n   * This is called when checking if a given key occurs in the cache.\n   * @param key - The cache key the item should be stored under, if available.\n   */\n  hasKey(key: string): Promise<boolean>;\n  /**\n   * This can be called to remove all existing entries from the cache.\n   */\n  clear(): Promise<void>;\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Note that each item in the cache is represented using the ",(0,s.jsx)(n.a,{href:"pathname:///api/v3/interfaces/sap-cloud-sdk_connectivity.CacheEntry.html",children:(0,s.jsx)(n.code,{children:"CacheEntry<T>"})})," type, which defines two properties:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"entry"})," - The item, i.e. destination, you want to cache."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"expires"})," - The expiration time of the entry in milliseconds.\nThis is optional."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["You are free to choose, how you implement the ",(0,s.jsx)(n.code,{children:"DestinationCacheInterface"}),", e.g. as a class or an object:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"// Custom cache implementation as an object\nconst customCache = {\n  set(\n    key: string | undefined,\n    { entry, expires }: CacheEntry<Destination>\n  ): Promise<void> {\n    // add entry to cache\n    // ensure entry expires after given time\n  },\n\n  get(key: string | undefined): Promise<Destination | undefined> {\n    // retrieve entry from cache\n  },\n\n  hasKey(key: string): Promise<boolean> {\n    // check cache based on key\n  },\n\n  clear(): Promise<void> {\n    // remove all entries from cache\n  }\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:["To use your custom cache, pass your implementation to the global ",(0,s.jsx)(n.a,{href:"pathname:///api/v3/functions/sap-cloud-sdk_connectivity.setDestinationCache.html",children:(0,s.jsx)(n.code,{children:"setDestinationCache()"})})," function before fetching destinations for the first time.\nAll subsequent calls to fetch destinations will use the custom cache."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"setDestinationCache(customCache);\n\n// ...\n\n.execute({ destination:'DESTINATION', jwt:'JWT', useCache: true })\n"})}),"\n",(0,s.jsx)(n.h2,{id:"registered-destination-cache",children:"Registered Destination Cache"}),"\n",(0,s.jsxs)(n.p,{children:["When ",(0,s.jsx)(n.a,{href:"/cloud-sdk/docs/js/v3/features/connectivity/destinations#register-destination",children:"registering destinations"})," using the ",(0,s.jsx)(n.a,{href:"pathname:///api/v3/functions/sap-cloud-sdk_connectivity.registerDestination.html",children:(0,s.jsx)(n.code,{children:"registerDestination()"})})," function, destinations are stored in a separate cache.\nThis cache is always enabled and behaves similarly to the destination cache discussed above.\nIt uses the same JWT-dependent defaults for the ",(0,s.jsx)(n.a,{href:"#isolation-strategy",children:"isolation strategy"})," as the destination cache.\nTo change the isolation strategy pass the ",(0,s.jsx)(n.code,{children:"isolationStrategy"})," option to the function."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"registerDestination(destination, {\n  jwt: 'JWT',\n  isolationStrategy: 'tenant'\n});\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Be cautious when downgrading the isolation strategy to avoid privilege escalation (see ",(0,s.jsx)(n.a,{href:"#changing-isolation-strategy",children:"change the isolation strategy"}),")."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { registerDestination } from '@sap-cloud-sdk/connectivity';\n\nconst destination = {\n  name: 'DESTINATION',\n  url: 'https://example.com'\n};\n\nregisterDestination(destination, { jwt: 'JWT' });\n"})}),"\n",(0,s.jsx)(n.p,{children:"You cannot replace the registered destination cache with a custom cache."})]})}function l(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var i=t(96540);const s={},a=i.createContext(s);function o(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);