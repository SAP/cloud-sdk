<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-docs-java docs-version-v3 docs-doc-page docs-doc-id-features/multi-tenancy/thread-context" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Multitenancy With the Thread Context | SAP Cloud SDK</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://sap.github.io/cloud-sdk/docs/java/v3/features/multi-tenancy/thread-context"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v3"><meta data-rh="true" name="docusaurus_tag" content="docs-docs-java-v3"><meta data-rh="true" name="docsearch:version" content="v3"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-docs-java-v3"><meta data-rh="true" property="og:title" content="Multitenancy With the Thread Context | SAP Cloud SDK"><meta data-rh="true" name="description" content="This article describes how the SAP Cloud SDK for Java provides an application context that is stored in a thread-safe manner and enables cloud-native features to be used out of the box."><meta data-rh="true" property="og:description" content="This article describes how the SAP Cloud SDK for Java provides an application context that is stored in a thread-safe manner and enables cloud-native features to be used out of the box."><meta data-rh="true" name="keywords" content="sap,cloud,sdk,thread context,multi tenancy,cloud native,tenant,user,principal,JWT,AuthToken"><link data-rh="true" rel="icon" href="/cloud-sdk/favicon.ico"><link data-rh="true" rel="canonical" href="https://sap.github.io/cloud-sdk/docs/java/v3/features/multi-tenancy/thread-context"><link data-rh="true" rel="alternate" href="https://sap.github.io/cloud-sdk/docs/java/v3/features/multi-tenancy/thread-context" hreflang="en"><link data-rh="true" rel="alternate" href="https://sap.github.io/cloud-sdk/docs/java/v3/features/multi-tenancy/thread-context" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://E4A268JVO0-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Thread Context","item":"https://sap.github.io/cloud-sdk/docs/java/v3/features/multi-tenancy/thread-context"}]}</script><link rel="search" type="application/opensearchdescription+xml" title="SAP Cloud SDK" href="/cloud-sdk/opensearch.xml"><link rel="stylesheet" href="/cloud-sdk/assets/css/styles.c8db7810.css">
<script src="/cloud-sdk/assets/js/runtime~main.0851789e.js" defer="defer"></script>
<script src="/cloud-sdk/assets/js/main.bdea3c5a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>document.documentElement.setAttribute("data-theme",window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-theme-choice","system"),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/cloud-sdk/img/logo.svg"><link rel="preload" as="image" href="/cloud-sdk/img/logo-dark.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cloud-sdk/"><div class="navbar__logo"><img src="/cloud-sdk/img/logo.svg" alt="SAP Cloud SDK" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/cloud-sdk/img/logo-dark.svg" alt="SAP Cloud SDK" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">SAP Cloud SDK</b></a><a class="navbar__item navbar__link" href="/cloud-sdk/docs/overview/overview-cloud-sdk">Overview</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" docspluginid="docs-java" href="/cloud-sdk/docs/java/overview-cloud-sdk-for-java">â˜• Java</a><a class="navbar__item navbar__link" docspluginid="docs-js" href="/cloud-sdk/docs/js/overview">ðŸš€ JavaScript</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://sap.github.io/ai-sdk" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">SAP Cloud SDK for AI<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/cloud-sdk/docs/java/v3/features/multi-tenancy/thread-context">v3</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cloud-sdk/docs/java/features/multi-tenancy/thread-context">v5</a></li><li><a class="dropdown__link" href="/cloud-sdk/docs/java/v4/features/multi-tenancy/thread-context">v4</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/cloud-sdk/docs/java/v3/features/multi-tenancy/thread-context">v3</a></li></ul></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Meta+k)" aria-keyshortcuts="Meta+k"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="8" stroke="currentColor" fill="none" stroke-width="1.4"></circle><path d="m21 21-4.3-4.3" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-sdk/docs/java/v3/overview-cloud-sdk-for-java"><span title="Overview" class="linkLabel_WmDU">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-sdk/docs/java/v3/getting-started"><span title="Getting Started" class="linkLabel_WmDU">Getting Started</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/cloud-sdk/docs/java/v3/features/odata/overview"><span title="Features" class="categoryLinkLabel_W154">Features</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/cloud-sdk/docs/java/v3/features/odata/overview"><span title="OData" class="categoryLinkLabel_W154">OData</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/cloud-sdk/docs/java/v3/features/rest/overview"><span title="OpenAPI" class="categoryLinkLabel_W154">OpenAPI</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cloud-sdk/docs/java/v3/features/bapi-and-rfc/overview"><span title="BAPI/RFC" class="linkLabel_WmDU">BAPI/RFC</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/cloud-sdk/docs/java/v3/features/connectivity/destination-service"><span title="Connectivity" class="categoryLinkLabel_W154">Connectivity</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/cloud-sdk/docs/java/v3/features/multi-tenancy/thread-context"><span title="Multitenancy" class="categoryLinkLabel_W154">Multitenancy</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cloud-sdk/docs/java/v3/features/multi-tenancy/thread-context"><span title="Thread Context" class="linkLabel_WmDU">Thread Context</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/cloud-sdk/docs/java/v3/features/resilience"><span title="Resilience &amp; Caching" class="categoryLinkLabel_W154">Resilience &amp; Caching</span></a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/cloud-sdk/docs/java/v3/environments/overview"><span title="Environments" class="categoryLinkLabel_W154">Environments</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/cloud-sdk/docs/java/v3/guides/manage-dependencies"><span title="Guides" class="categoryLinkLabel_W154">Guides</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/cloud-sdk/docs/java/v3/extensions/extensions-supported-by-sap-cloud-sdk-for-java"><span title="Extensions" class="categoryLinkLabel_W154">Extensions</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/cloud-sdk/docs/java/v3/video/video-tutorial-about-getting-started-with-sap-cloud-sdk-for-java"><span title="Video Tutorials" class="categoryLinkLabel_W154">Video Tutorials</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-sdk/docs/java/v3/troubleshooting-frequent-problems"><span title="Troubleshooting" class="linkLabel_WmDU">Troubleshooting</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-sdk/docs/java/v3/release-policy"><span title="Release Policy" class="linkLabel_WmDU">Release Policy</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-sdk/docs/java/v3/release-notes"><span title="Release Notes" class="linkLabel_WmDU">Release Notes</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-sdk/docs/java/v3/frequently-asked-questions"><span title="FAQ" class="linkLabel_WmDU">FAQ</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://search.maven.org/search?q=g:com.sap.cloud.sdk*" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK"><span title="Maven Central" class="linkLabel_WmDU">Maven Central</span><svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->SAP Cloud SDK<!-- --> <b>v3</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/cloud-sdk/docs/java/features/multi-tenancy/thread-context">latest version</a></b> (<!-- -->v5<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/cloud-sdk/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Features</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Multitenancy</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Thread Context</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Multitenancy With the Thread Context</h1></header><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-a-thread-context">What Is a Thread Context?<a href="#what-is-a-thread-context" class="hash-link" aria-label="Direct link to What Is a Thread Context?" title="Direct link to What Is a Thread Context?" translate="no">â€‹</a></h2>
<p>The SAP Cloud SDK for Java provides a so-called <code>ThreadContext</code>.
It serves as thread-safe storage for potentially sensitive information.
Specifically, the following three objects are stored:</p>
<ul>
<li class="">The current <em>Tenant</em></li>
<li class="">The current <em>Principal</em> (User)</li>
<li class="">The <a href="https://jwt.io" target="_blank" rel="noopener noreferrer" class="">JSON Web Token</a> (JWT)</li>
</ul>
<p>This information is used throughout the SAP Cloud SDK to provide features like tenant and principal isolation, JWT verification and authorization against other systems and services.
To ensure different tenants and users are properly isolated in an application, this information is always limited to the thread it was created on unless it is explicitly passed on by the application (see <a href="#running-asynchronous-operations" class="">Propagating the Thread Context</a>).</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Multi-tenancy describes the access of different, technically separated user groups to the same instance of an application.
In the terms of XSUAA service, these user groups are called Tenants, while in terms of Identity Authentication Service (IAS) they are called Zones.</p><p>The SAP Cloud SDK for Java uses the term <em>Tenant</em> to refer to both XSUAA Tenants and IAS Zones.
This implies, that the <em>tenantId</em> exposed in the <em>Tenant</em> interface either returns the <em>tenantId</em> or <em>zoneId</em>, depending on the context you are currently running in.</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-is-a-thread-context-created">How Is a Thread Context Created?<a href="#how-is-a-thread-context-created" class="hash-link" aria-label="Direct link to How Is a Thread Context Created?" title="Direct link to How Is a Thread Context Created?" translate="no">â€‹</a></h2>
<p>The SAP Cloud SDK provides a <a href="https://help.sap.com/doc/b579bf8578954412aea2b458e8452201/1.0/en-US/com/sap/cloud/sdk/cloudplatform/servlet/RequestAccessorFilter.html" target="_blank" rel="noopener noreferrer" class=""><code>RequestFilter</code></a> that will listen to incoming HTTP requests.
This filter will extract <strong>all</strong> provided HTTP headers from the incoming request and store them in the <code>ThreadContext</code>.
Additionally, if the <code>Authorization</code> header contains a <code>JWT</code> from the <a href="https://blogs.sap.com/2020/04/03/sap-application-router/" target="_blank" rel="noopener noreferrer" class=""><code>AppRouter</code></a>, the filter will:</p>
<ul>
<li class="">Verify this token</li>
<li class="">Store it in the <code>ThreadContext</code> and</li>
<li class="">Pull the <em>Tenant</em> and <em>Principal</em> information from it</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Integration with CAP</div><div class="admonitionContent_BuS1"><p>In case you are using CAP (with the <code>cds-integration-cloud-sdk</code> dependency) the Tenant,Principal information and Headers will <strong>instead</strong> be derived from the <a href="https://cap.cloud.sap/docs/java/request-contexts" target="_blank" rel="noopener noreferrer" class="">CAP Request Context</a>.
That also means that the <code>ThreadContext</code> will not be used when accessing this information.
Please note that the <code>RequestScopedHttpClientCache</code> which is the default being used by the SAP Cloud SDK cannot work with this approach.</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-can-the-thread-context-be-used">How Can the Thread Context Be Used?<a href="#how-can-the-thread-context-be-used" class="hash-link" aria-label="Direct link to How Can the Thread Context Be Used?" title="Direct link to How Can the Thread Context Be Used?" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="accessing-information">Accessing Information<a href="#accessing-information" class="hash-link" aria-label="Direct link to Accessing Information" title="Direct link to Accessing Information" translate="no">â€‹</a></h3>
<p>The Thread context can be accessed via the static <a href="https://help.sap.com/doc/b579bf8578954412aea2b458e8452201/1.0/en-US/com/sap/cloud/sdk/cloudplatform/thread/ThreadContextAccessor.html" target="_blank" rel="noopener noreferrer" class=""><code>ThreadContextAccessor</code></a>.</p>
<p>For the frequently needed <em>HTTP Headers</em>, <em>Tenant</em>, <em>Principal</em>, and <em>JWT</em> there are also dedicated accessors:</p>
<ul>
<li class=""><code>RequestHeaderAccessor</code></li>
<li class=""><a href="https://help.sap.com/doc/b579bf8578954412aea2b458e8452201/1.0/en-US/com/sap/cloud/sdk/cloudplatform/tenant/TenantAccessor.html" target="_blank" rel="noopener noreferrer" class=""><code>TenantAccessor</code></a></li>
<li class=""><a href="https://help.sap.com/doc/b579bf8578954412aea2b458e8452201/1.0/en-US/com/sap/cloud/sdk/cloudplatform/security/principal/PrincipalAccessor.html" target="_blank" rel="noopener noreferrer" class=""><code>PrincipalAccessor</code></a></li>
<li class=""><a href="https://help.sap.com/doc/b579bf8578954412aea2b458e8452201/1.0/en-US/com/sap/cloud/sdk/cloudplatform/security/AuthTokenAccessor.html" target="_blank" rel="noopener noreferrer" class=""><code>AuthTokenAccessor</code></a></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="storing-information">Storing Information<a href="#storing-information" class="hash-link" aria-label="Direct link to Storing Information" title="Direct link to Storing Information" translate="no">â€‹</a></h3>
<p>The <a href="https://help.sap.com/doc/b579bf8578954412aea2b458e8452201/1.0/en-US/com/sap/cloud/sdk/cloudplatform/thread/ThreadContext.html" target="_blank" rel="noopener noreferrer" class=""><code>ThreadContext</code></a> allows for some manipulation by the application.
However, oftentimes it is more convenient to leverage the <code>executeWith...()</code> functionality offered by the dedicated accessors.</p>
<p>Consider a scenario where some part of the code should run on behalf of a specific tenant.
In that case you can override the current tenant explicitly:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">TenantAccessor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">executeWithTenant</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customTenant</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doStuff</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>CAP Integration</div><div class="admonitionContent_BuS1"><p>The above does not apply for any accessors like <code>TenantAccessor</code>, <code>PrincipalAccessor</code>, <code>RequestHeaderAccessor</code> when using the CAP framework (with the <code>cds-integration-cloud-sdk</code> dependency).
When using CAP the Tenant,Principal information and Headers are derived from the <code>RequestContext</code>.
Please refer to <a href="https://cap.cloud.sap/docs/java/request-contexts#defining-requestcontext" target="_blank" rel="noopener noreferrer" class="">this section</a> on how to override existing values in the CAP context.</p></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_BuS1"><p>Be aware, that the <code>executeWith</code> methods shown above only replaces the given property, but does not update properties derived from it.</p><p>Example: You have a special <code>AuthToken</code>, that you propagate with <code>AuthTokenAccessor.executeWithAuthToken</code>.
Inside the given code block only the <code>AuthToken</code> will be replaced, while e.g. the <code>Tenant</code> is the same as in the original context.</p><p>If you want to start a fresh context based on a given <code>AuthToken</code>, for example accessing information of the provider tenant while in a subscriber context, have a look at this code:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Tenant</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">retrieveProviderTenant</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// retrieves an access token from the provider context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AuthToken</span><span class="token plain"> providerXsuaaAccessToken </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">AuthTokenAccessor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getXsuaaServiceToken</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ThreadContextExecutor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// don&#x27;t reuse the original context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">withoutParentThreadContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// add the provider token into the new context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">withListeners</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AuthTokenThreadContextListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">providerXsuaaAccessToken</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// return the actual provider tenant</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TenantAccessor</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">getCurrentTenant</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="manipulating-http-headers">Manipulating HTTP Headers<a href="#manipulating-http-headers" class="hash-link" aria-label="Direct link to Manipulating HTTP Headers" title="Direct link to Manipulating HTTP Headers" translate="no">â€‹</a></h3>
<p>The <code>RequestHeaderAccessor#getHeaderContainer()</code> method provides convenient access to the HTTP headers of the current incoming request.
It returns an instance of <code>RequestHeaderContainer</code>, which is, by API contract, an <strong>immutable</strong> container that allows <em>case insensitive</em> access to HTTP header values.
Although the <code>RequestHeaderContainer</code> cannot be altered once created, there are scenarios where manipulating HTTP headers is required.
In such cases, a new instance of <code>RequestHeaderContainer</code> can be created in a few different ways.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-a-new-requestheadercontainer-from-scratch">Create a new RequestHeaderContainer From Scratch<a href="#create-a-new-requestheadercontainer-from-scratch" class="hash-link" aria-label="Direct link to Create a new RequestHeaderContainer From Scratch" title="Direct link to Create a new RequestHeaderContainer From Scratch" translate="no">â€‹</a></h4>
<p>A common way to represent HTTP headers is to use <code>Map&lt;String, String&gt;</code> for <code>1:1</code> relationships between header names and values or even <code>Map&lt;String, Collection&lt;String&gt;&gt;</code> for <code>1:n</code> relationships.
To make the transition from either of those representations to the SAP Cloud SDK&#x27;s <code>RequestHeaderContainer</code> as easy as possible, the <code>DefaultRequestHeaderContainer</code> offers corresponding factory methods:</p>
<ul>
<li class=""><code>fromSingleValueMap(Map&lt;String, String&gt;)</code> and</li>
<li class=""><code>fromMultiValueMap(Map&lt;String, Collection&lt;String&gt;&gt;)</code></li>
</ul>
<p>Besides these two factory methods, the <code>DefaultRequestHeaderContainer</code> also offers the possibility to create an instance of <code>RequestHeaderContainer.Builder</code> through the static <code>builder()</code> method.
An example for how the returned <code>Builder</code> can be used is shown in the chapter below.</p>
<p>Additionally, to make customizing the current HTTP headers even easier, the <code>RequestHeaderAccessor</code> comes with an overload of the <code>executeWithHeaderContainer</code> method that accepts a <code>Map&lt;String, String&gt;</code>.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="updating-an-existing-requestheadercontainer">Updating an Existing RequestHeaderContainer<a href="#updating-an-existing-requestheadercontainer" class="hash-link" aria-label="Direct link to Updating an Existing RequestHeaderContainer" title="Direct link to Updating an Existing RequestHeaderContainer" translate="no">â€‹</a></h4>
<p>As pointed out above, the <code>RequestHeaderContainer</code> is an <strong>immutable</strong> structure.
Therefore, updating an already existing instance is impossible.</p>
<p><strong>However</strong>, in cases where you would like to, for example, just add a new custom header to the set of existing headers, the <code>RequestHeaderContainer</code> offers the <code>toBuilder</code> method.
As the name suggests, this method can be used to retrieve an instance of <code>RequestHeaderContainer.Builder</code>.
In contrast to the <code>RequestHeaderContainer</code>, the <code>Builder</code> can be <strong>changed</strong> as much as needed.
Additionally, the <code>toBuilder</code> method will make sure that the returned <code>Builder</code> instance is already pre-filled with all HTTP headers that are also present in the instance of <code>RequestHeaderContainer</code>.</p>
<p>To make things less theoretical, let&#x27;s examine an example.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Example: Usage of the Builder</summary><div><div class="collapsibleContent_i85q"><p>Assume your application received an HTTP request that contains the following headers</p><ul>
<li class=""><code>Authorization: Bearer DUMMY_JWT</code></li>
<li class=""><code>Set-Cookie: cookie-1; cookie-2</code></li>
<li class=""><code>Accept-Language: en-US</code></li>
<li class=""><code>x-app-specific-header: customer-value</code></li>
</ul><p>These values can be accessed as follows:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">RequestHeaderContainer</span><span class="token plain"> headers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">RequestHeaderAccessor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHeaderContainer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHeaderValues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;authorization&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// will return [&quot;Bearer DUMMY_JWT&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHeaderValues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;set-cookie&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// will return [&quot;cookie-1&quot;, &quot;cookie-2&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHeaderValues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;accept-language&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// will return [&quot;en-US&quot;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getHeaderValues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-app-specific-header&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// will return [&quot;customer-value&quot;]</span><br></span></code></pre></div></div><p>Note how accessing the values for specific HTTP headers will work independent of the casing of the provided name.</p><p>Now let&#x27;s say your use case requires that HTTP cookies shall not be leaked into further application execution.
Additionally, you have to make sure that the <code>x-app-specific-header</code> contains an additional application provided value.
Lastly, our application should always serve German customers and, therefore, you need to make sure the <code>Accept-Language</code> header is always adjusted accordingly.</p><p>Using the <code>Builder</code> API, fulfilling these requirements is straightforward:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">RequestHeaderContainer</span><span class="token plain"> updatedHeaders </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    headers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">withoutHeader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;set-cookie&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">withHeader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;x-app-specific-header&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;application-value&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">replaceHeader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;accept-language&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;de-DE&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div><p>Once again, the API guarantees that header names are treated <em>case insensitively</em>.</p><p>Finally, to make sure the updated headers are also taken into consideration, you have to overwrite the existing headers in our <code>ThreadContext</code>.
This can be done using the following code:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">RequestHeaderAccessor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">executeWithHeaderContainer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">updatedHeaders</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">yourBusinessLogic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div></div></div></details>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="running-asynchronous-operations">Running Asynchronous Operations<a href="#running-asynchronous-operations" class="hash-link" aria-label="Direct link to Running Asynchronous Operations" title="Direct link to Running Asynchronous Operations" translate="no">â€‹</a></h3>
<p>As the name suggests the <code>ThreadContext</code> is bound to a thread, more specifically to the one it was created.
If asynchronous operations need to access the information, it has to be propagated to the new threads.</p>
<p>The following code achieves this:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">ThreadContextExecutor</span><span class="token plain"> executor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ThreadContextExecutor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Callable</span><span class="token plain"> operationWithContext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> executor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">operation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">invokeAsynchronously</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operationWithContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>Take note that the <code>ThreadContextExecutor</code> is created <em>before</em> performing the asynchronous operation.
This is important because only at that time the context is available and will be propagated.</p>
<p>A similar approach can be applied with the <code>RequestHeader</code>, <code>Tenant</code>, <code>Principal</code> and <code>AuthToken</code> accessors.
This code runs an asynchronous operation with a dedicated tenant:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Callable</span><span class="token plain"> operationWithTenant </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">TenantAccessor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">executeWithTenant</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customTenant</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">operation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">invokeAsynchronously</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operationWithContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>CAP Integration</div><div class="admonitionContent_BuS1"><p>In case you are using CAP the CAP Request Context needs to be passed on instead of the <code>ThreadContext</code>.
Please refer to <a class="" href="/cloud-sdk/docs/java/v3/guides/cap-sdk-integration">this guide</a> on how to achieve this.</p></div></div>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>Thread Lifecycle</div><div class="admonitionContent_BuS1"><p>Be cautious with long-running, asynchronous operations.
A propagated thread context will only persist as long as the thread lives that it was created on.
When the parent thread dies the context will cease to exist and no longer be available in any of the threads.</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Details</summary><div><div class="collapsibleContent_i85q"><p></p><summary> Workaround </summary>
You can work around this limitation with the following approach:<p></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">RequestHeaderContainer</span><span class="token plain"> requestHeaders </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">RequestHeaderAccessor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">tryGetHeaderContainer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getOrElse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RequestHeaderContainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">EMPTY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">ThreadContextExecutor</span><span class="token plain"> executor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ThreadContextExecutor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">withThreadContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">DefaultThreadContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">withListeners</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">RequestHeaderThreadContextListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requestHeaders</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Callable</span><span class="token plain"> operationWithContext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> executor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">operation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">invokeAsynchronously</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operationWithContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div></div></div></details></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/SAP/cloud-sdk/edit/main/docs-java_versioned_docs/version-v3/features/multi-tenancy/thread-context.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/cloud-sdk/docs/java/v3/features/connectivity/mtls"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Certificate-based Authentication</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cloud-sdk/docs/java/v3/features/resilience"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Resilience</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-a-thread-context" class="table-of-contents__link toc-highlight">What Is a Thread Context?</a></li><li><a href="#how-is-a-thread-context-created" class="table-of-contents__link toc-highlight">How Is a Thread Context Created?</a></li><li><a href="#how-can-the-thread-context-be-used" class="table-of-contents__link toc-highlight">How Can the Thread Context Be Used?</a><ul><li><a href="#accessing-information" class="table-of-contents__link toc-highlight">Accessing Information</a></li><li><a href="#storing-information" class="table-of-contents__link toc-highlight">Storing Information</a></li><li><a href="#manipulating-http-headers" class="table-of-contents__link toc-highlight">Manipulating HTTP Headers</a></li><li><a href="#running-asynchronous-operations" class="table-of-contents__link toc-highlight">Running Asynchronous Operations</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">SAP Cloud SDK for Java</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://developers.sap.com/tutorial-navigator.html?tag=products:technology-platform/sap-cloud-sdk/sap-cloud-sdk" target="_blank" rel="noopener noreferrer" class="footer__link-item">Tutorials<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://central.sonatype.com/search?q=g:com.sap.cloud.sdk*&amp;smo=true" target="_blank" rel="noopener noreferrer" class="footer__link-item">Maven<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/cloud-sdk/docs/java/support">Support</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">SAP Cloud SDK for JavaScript</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/cloud-sdk/docs/js/tutorials/getting-started/introduction">Tutorials</a></li><li class="footer__item"><a href="https://www.npmjs.com/search?q=%40sap-cloud-sdk" target="_blank" rel="noopener noreferrer" class="footer__link-item">npm<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/SAP/cloud-sdk-js" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/SAP-samples/cloud-sdk-js" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sample repository<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/cloud-sdk/docs/js/support">Support</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Additional Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/sap-cloud-sdk" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://community.sap.com/topics/cloud-sdk" target="_blank" rel="noopener noreferrer" class="footer__link-item">SAP Cloud SDK Community Page<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://answers.sap.com/tags/73555000100800000895" target="_blank" rel="noopener noreferrer" class="footer__link-item">SAP Cloud SDK on SAP Answers<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://help.sap.com/viewer/product/SAP_CLOUD_SDK/1.0/en-US?task=discover_task" target="_blank" rel="noopener noreferrer" class="footer__link-item">SAP Cloud SDK on SAP Help<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://sap.github.io/ai-sdk" target="_blank" rel="noopener noreferrer" class="footer__link-item">SAP Cloud SDK for AI<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2025 SAP SE or an SAP affiliate company. All rights reserved.</div></div></div></footer></div>
</body>
</html>