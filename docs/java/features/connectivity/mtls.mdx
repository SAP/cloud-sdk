---
id: sdk-connectivity-mtls
title: Certificate-Based Authentication Using SAP Cloud SDK
hide_title: false
hide_table_of_contents: false
sidebar_label: Certificate Based Authentication
description: This article describes how the SAP Cloud SDK for Java can be used to establish connections to other cloud services using mTLS
keywords:
  - sap
  - cloud
  - sdk
  - mTLS
  - java
  - connectivity
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

:::danger

Currently, support for Certificate-based Authentication from SAP Cloud SDK is fully end-to-end tested only with the `XSUAA` service.
`Destination` and `Connectivity` services should also work but are not yet fully tested.

:::

The SAP Cloud SDK supports certificate-based authentication while establishing connections to other cloud services like `XSUAA` or `Destination` service.

## Why mTLS
Mutual `TLS` or `mTLS` for short is a method for mutual authentication.
It ensures that before proceeding with the `HTTP` exchange both the client and the server each mutually verify each other's identities by the use of `X.509` certificates.

## Usage of Client Credentials and Shortcomings
If a service or an application is protected using [`XSUAA`](https://help.sap.com/viewer/65de2977205c403bbc107264b8eccf4b/Cloud/en-US/6373bb7a96114d619bfdfdc6f505d1b9.html), an access token from `XSUAA` is required to access the protected service or application.
To obtain an access token or `JWT`, first the `clientid`, `clientsecret` and `uri` is extracted from the service binding and then using the `url` from `xsuaa` service binding, a [`token flow`](https://github.com/SAP/cloud-security-xsuaa-integration/tree/main/token-client) is triggered to obtain a `JWT`.

Please note that the process of obtaining the `JWT` is internally carried out by the SAP Cloud SDK and application developers do not need to worry about doing this explicitly.
Now, adding this obtained `JWT` as an `Authorization` header to the request to the service, ensures that your request gets authorized and authenticated.

However there is always the inherent risk that these credentials may get leaked.
These credentials are typically not frequently changed as well.
With the use of certificates the risk of leaking powerful technical user credentials can be mitigated.

## Certificate Based Authentication for Services

:::info Hint
Certificate based authentication is presumably going to be the default authentication mechanism on SAP BTP Cloud Foundry, Canary landscape starting from Sept. 13th 2021.
:::
To adhere to the latest recommended security best practices by SAP, some re-use and kernel services have enabled certificate based authentication.
As a consequence, SAP Cloud SDK also supports certificate based authentication while accessing these services.
In general, if a service binding has a property `credentials: { credential-type: x509 }` then this is an indication that certificate based authentication can be used to access the service.

`XSUAA` service is one among the services that has enabled certificate based authentication.
This means that in the service binding in addition to the `client_secret` you will also find a `certificate` and `key` entry now.
Example:
```
{
    "VCAP_SERVICES": {
		"xsuaa": [
			{
				"label": "xsuaa",
				...
				"credentials": {
				    ...
				    "credential-type": "x509"
					"clientid": "fictional-client-id",
					"clientsecret": "fictional-secret",
					"certificate": "-----BEGIN CERTIFICATE-----fictional-certificate-----END CERTIFICATE-----\n",
					"key": "key"
					...
				},
			}
		]
	}
}
```
This certificate would now be used to establish a secure session to obtain the `JWT` instead of the client credentials token flow used previously.
Please note that the process of obtaining the `JWT` is still internally carried out by the SAP Cloud SDK.
The only difference is that the provided `certificate` is used to authenticate the client.

## Validity of Certificates
The `X.509` certificates used in the service binding could either be external or `XSUAA` managed.

:::danger

By default `XSUAA` managed certificates are valid only for 7 days.
To obtain a new certificate, deletion and re-creation of service binding is required.
The application also needs to be restarted to update the service binding.

:::

To extend the validity of the `XSUAA` managed certificate you could use parameters while creating a service binding.

`cf bind-service myapp myservice -c parameters.json`

```json
{
  "credential-type": "x509",
  "x509": {
    "key-length": 2048,
    "validity": 365,
    "validity-type": "DAYS"
  }
}
```
This way you can extend the validity of the generated `certificate` to a maximum of one year.

## Sticking to Client Credentials
If you do not want to use Certificate based Authentication to obtain your `JWT`s and still want to continue using Client Credentials you can do that by configuring your service instances.
Ensure that your `xs-security.json` contains the `instance-secret` as the first entry in property `credential-types`

```json
"oauth2-configuration": {
  "credential-types": ["instance-secret"]
}
```