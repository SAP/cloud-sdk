## 5.0.0

[Maven Central](https://search.maven.org/search?q=g:com.sap.cloud.sdk*%20AND%20v:5.0.0)

### Improvements

This is the first release of the SAP Cloud SDK version 5.
As this is a new major version, this release contains a lot of (under the hood) improvements, refactoring, and other changes.
Please refer to the [Upgrade Guide](../guides/5.0-upgrade-steps.mdx) for details instructions on how to upgrade your SAP Cloud SDK dependencies to our new major version and for a detailed list of changes.

- Both `HttpDestination` as well as `HttpDestinationProperties` are now sub-types of `Destination` for improved compatibility with the Cloud SDK APIs.
- The `Destination#asHttp()` and `Destination#asRfc()` methods no longer always return a new instance of `HttpDestination` and `RfcDestination` if the current objects is already a `HttpDestination` or `RfcDestination` respectively.
- `Destination#asHttp()` no longer throws an exception in case the `Destination` originates from the Destination service and the attached auth token contains an error.
  Instead, an exception will be thrown upon invoking the `getHeaders()` method, for example, during request execution.

- Dependency Updates:
  - SAP dependency updates:
    - Update `com.sap.cloud.security:java-bom` from `2.14.2` to `3.2.1`
  - Other dependency updates:
    - Major version updates:
      - Update `org.springframework:spring-framework-bom` from `5.3.29` to `6.0.13`. **Note** This dependency is used by the SDK **internally only**. In other words: This update **does not** affect consuming projects that use the `sdk-bom` for dependency management.
      - Update `org.slf4j:slf4j-api` from `1.7.36` to `2.0.9`
      - Update `com.github.ben-manes.caffeine:caffeine` from `2.9.3` to `3.1.8`

### Compatibility Notes

- The SAP Cloud SDK has switched its license from [SAP DEVELOPER LICENSE AGREEMENT](https://tools.hana.ondemand.com/developer-license-3_1.txt) to [The Apache Software License, Version 2.0](https://www.apache.org/licenses/LICENSE-2.0.txt)
- The SAP Cloud SDK has switched the minimum required Java version to 17
- The SAP Cloud SDK version 5 is no longer compatible with Spring version 5, the [XSUAA Client Library](https://github.com/SAP/cloud-security-services-integration-library) version 2, the SAP Java Buildpack version 1 and TomEE version 8.x or 9.x.
- Many modules have been renamed and/or moved to different packages. Please refer to the [Upgrade Guide](../guides/5.0-upgrade-steps.mdx) for details.

- Following public methods have been removed:
  - Related to the `Destination` API:
    - The `Destination#decorate` method has been removed without replacement.
- Removed the following elements from enum `com.sap.cloud.sdk.cloudplatform.connectivity.AuthenticationType`:
  - `APP_TO_APP_SSO`
  - `INTERNAL_SYSTEM_AUTHENTICATION`
- Removed the deprecated enum element `CURRENT_TENANT_THEN_PROVIDER` from `com.sap.cloud.sdk.cloudplatform.connectivity.ScpCfDestinationRetrievalStrategy`.
  As alternative please run the destination lookup queries separately in your application for `ONLY_SUBSCRIBER` and `ALWAYS_PROVIDER` as fallback.
- Removed the `javax.inject.Named` annotation from the OData Generator (v2, v4).
- Other changes to the Destination API:
  - Retrieving a `Destination` from the Destination service (i.e. using the `ScpCfDestinationLoader`) will now throw an exception if any of the attached certificates isn't valid.
  - Retrieving a `Destination` from the Destination service (i.e. using the `ScpCfDestinationLoader`) will no longer eagerly evaluate On-Premise related headers (if applicable).
    Instead, those headers will be evaluated lazily upon request execution.
    As a consequence, the `getHeaders` method might now throw an exception if the current tenant is different from the tenant the destination belongs to.
  - Changed following `DestinationPropertyKey` instances:
    - `AUTH_TYPE`: `authentication` -> `Authentication`
    - `CERTIFICATES`: `certificates` -> `cloudsdk.certificates`
    - `AUTH_TOKENS`: `authTokens` -> `cloudsdk.authTokens`
    - These changes are most relevant for users who are **not** already using these constant `DestinationPropertyKey` instances but instead retrieved properties from `DestinationProperties` (and sub-types) using the `get(String, Function)` method.
  - The public constructor of `DefaultHttpDestination` has been replaced with a static factory method `DefaultHttpDestination#fromProperties`.
    - We also added some extra static factory methods (`DefaultHttpDestination#fromMap` and `DefaultHttpDestination#fromDestination`) for convenience. Please refer to the JavaDoc for further details.
  - The public constructor of `DefaultDestination` has been replaced with a static factory method `DefaultHttpDestination#fromMap`.
    - We also added an extra static factory method `DefaultHttpDestination#fromProperties` for convenience. Please refer to the JavaDoc for further details.
  - The `DefaultHttpDestination.Builder` has been modified in the following ways:
    - The `user(String)` and `password(String)` methods have been replaced with `basicCredentials(String, String)`.
    - Using any overload of `basicCredentials` will now automatically set the `AuthenticationType` to `BASIC_AUTHENTICATION`.
    - Using `proxyConfiguration(ProxyConfiguration)` will now throw an `IllegalArgumentException` in case the contained `Credentials` are not supported. Supported types are `BearerCredentials` and `NoCredentials`.
  - The `BearerCredentials` behavior has been adjusted slightly: The `getToken()` method no longer just returns the value passed in via the constructor but instead is now guaranteed to **NOT** contain the prefix `"Bearer "`. To compensate this change, the `#getHttpHeaderValue()` method has been added, which is guaranteed to contain the `"Bearer "` prefix.
  - Invoking `HttpDestination#getHeaders(...)` may throw a `ResilienceRuntimeException` in case On-Premise Connectivity proxy headers cannot be resolved.
    As usual, the specific error cause is attached to the exception.
  - The deprecated `ClientCredentialsHttpDestination` has been removed in favor of the improved `OAuth2DestinationBuilder`.
  - The `OAuth2DestinationBuilder` has been changed to allow for setting arbitrary destination properties after the OAuth2 configuration has been set.
    - The `.withProperties(..)` aspect of the builder has been replaced with `.withProperty(..)`.
- The following classes have been moved or their modules have been renamed:
  - All classes related to the Apache Http Client 4 have been moved from `com.sap.cloud.sdk.cloudplatform:cloudplatform-connectivity` to a new module `com.sap.cloud.sdk.cloudplatform:connectivity-apache-httpclient4`
  - All classes related to the Apache Http Client 5 have been moved from `com.sap.cloud.sdk.frameworks:apache-httpclient5` to `com.sap.cloud.sdk.cloudplatform:connectivity-apache-httpclient5`
  - All classes related to Resilience4j have been moved from `com.sap.cloud.sdk.frameworks:resilience4j` to `com.sap.cloud.sdk.cloudplatform:resilience4j`
  - The following classes have been moved from `com.sap.cloud.sdk.cloudplatform:secuirty-scp-cf` to '`com.sap.cloud.sdk.cloudplatform:security`:
    - `AuthTokenThreadContextListener`
    - `BasicAuthenticationAccessor`
    - `BasicAuthenticationFacade`
    - `BasicAuthenticationThreadContextListener`
    - `DefaultAuthTokenFacade`
    - `DefaultBasicAuthenticationFacade`
    - `SecurityContextThreadContextDecorator`
    - `ScpCfSecretStore`
    - `ScpCfSecretStoreFacade`
    - `BasicAuthenicationAccessException`
  - The following classes have been moved from `com.sap.cloud.sdk.cloudplatform:cloudplatform-core-dwc` to `com.sap.cloud.sdk.cloudplatform:connectivity-dwc`:
    - `DwcHeaderUtils`
    - `DwcHeaderNotFoundException`
  - `com.sap.cloud.sdk.cloudplatform.security.DwcPrincipalFacade` has been moved from `com.sap.cloud.sdk.cloudplatform:security-dwc` to `com.sap.cloud.sdk.cloudplatform:connectivity-dwc`
  - `com.sap.cloud.sdk.cloudplatform.tenant.DwcTenantFacade` has been moved from `com.sap.cloud.sdk.cloudplatform:tenant-dwc` to `com.sap.cloud.sdk.cloudplatform:connectivity-dwc`
  - The module `cloudplatform-connectivity-scp-cf` got renamed to `connectivity-destination-service`, and all classes therein that started with `ScpCf...` got this prefix renamed to `DestinatinService...`. To prevent breaking changes with the renamed module the `cloudplatform-connectivity-scp-cf` module is still available as a dependency, but it is empty and just contains a reference to the new module `connectivity-destination-service`.
- The `HttpClientAccessor` and `ApacheHttpClient5Accessor` classes are generalised to accept `Destination` instances, making invocations to `.asHttp()` superfluous when obtaining HTTP clients.
- The `getSslContext()` method was removed from the `CloudPlatform` interface and the implementation was moved to the modules `connectivity-apache-httpclient4` and `connectivity-apache-httpclient5`.
- The OData, OpenAPI and SOAP APIs are generalised to accept instances of `Destination`, making invocations to `.asHttp()` superfluous when executing OData or REST requests.
  - OData V2 and OpenAPI clients need to be re-generated to adjust for this change.
- The public constructor of `DefaultPrincipal` now only accepts a String argument for `principalId`.
- The `PrincipalFacade` of the `PrincipalAccessor` will default to `DefaultPrincipalFacade` in the case that a facade cannot be found.
- The `RequestHeaderContainer` no longer splits header values.
- The `ODataRequestResult` no longer splits header values.
- The `AuthTokenFacade` of the `AuthTokenAccessor` will default to `DefaultAuthTokenFacade`
- The `TenantFacade` of the `TenantAccessor` will default to `DefaultTenantFacade`
- The `TenantWithSubdomain#getSubdomain` is now nullable.

### Known Issues

### New Functionality

### Fixed Issues

- Fixed a bug where an `Authorization` header was attached multiple times to outgoing HTTP requests under some circumstances
- Fixed an issue where the `DestinationType` of an `DefaultHttpDestination` could be changed to anything but `DestinationType.HTTP`
- Fixed an issue with custom GSON serialization of OpenAPI generated classes having unexpected `customFieldNames` properties in JSON payload.
